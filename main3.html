<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Geotab API Runner</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      margin: 0; 
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    input, select, textarea { 
      margin: 8px 0; 
      padding: 12px 16px; 
      width: 100%; 
      box-sizing: border-box; 
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fff;
    }
    
    button { 
      cursor: pointer; 
      margin: 6px 3px; 
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-success { 
      background: linear-gradient(135deg, #56ab2f, #a8e6cf);
      color: white;
    }
    .btn-info { 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-danger { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
    }
    
    .error { 
      color: #721c24; 
      background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
      padding: 16px; 
      border-radius: 8px; 
      margin: 12px 0; 
      border-left: 4px solid #dc3545;
    }
    
    .success { 
      color: #155724; 
      background: linear-gradient(135deg, #d4edda, #c3e6cb); 
      padding: 16px; 
      border-radius: 8px; 
      margin: 12px 0; 
      border-left: 4px solid #28a745;
    }
    
    .warning { 
      background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
      color: #856404; 
      padding: 16px; 
      border-radius: 8px; 
      margin: 12px 0; 
      border-left: 4px solid #ffc107;
    }
    
    .result { 
      white-space: pre-wrap; 
      background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
      padding: 20px; 
      margin: 12px 0; 
      border-radius: 8px; 
      max-height: 400px; 
      overflow-y: auto; 
      border: 1px solid #dee2e6;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
    }
    
    .section { 
      border: none; 
      padding: 24px; 
      margin: 16px 0; 
      border-radius: 12px; 
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }
    
    h2, h3 { 
      margin-top: 0; 
      color: #2c3e50; 
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; margin: -20px -20px 24px -20px; border-radius: 12px 12px 0 0; text-align: center;">
      <h2>üöÄ Geotab API Runner</h2>
      <p>Professional Toolkit ‚Ä¢ Complete fleet management API testing environment</p>
    </div>
    
    <div class="success">
      <strong>‚úÖ SIMPLIFIED VERSION - Authentication Fixed</strong><br>
      üî• Uses direct onclick handlers for reliable authentication
    </div>

    <div class="section">
      <h3>üîê Authentication</h3>
      <div class="warning">
        <strong>üîí Security Note:</strong> Credentials are not stored and remain within your browser session only.
      </div>
      <input id="server" placeholder="üåê Server (e.g., my.geotab.com)" value="">
      <input id="database" placeholder="üóÑÔ∏è Database" value="">
      <input id="username" placeholder="üë§ Username" value="">
      <input id="password" placeholder="üîë Password" type="password" value="">
      <button onclick="authenticate()">üîë Authenticate</button>
      <div id="authResult"></div>
    </div>

    <div id="apiSection" style="display:none;" class="section">
      <h3>üîß API Testing</h3>
      <div class="success">
        <span>‚úÖ Connected to Geotab</span>
      </div>
      <div>
        <p><strong>üñ•Ô∏è Server:</strong> <span id="connectedServer"></span></p>
        <p><strong>üóÑÔ∏è Database:</strong> <span id="connectedDB"></span></p>
        <p><strong>üë§ User:</strong> <span id="connectedUser"></span></p>
      </div>
      
      <input id="groupId" placeholder="üè¢ Group ID (e.g., GroupCompanyId)" value="GroupCompanyId">
      <input id="diagnosticId" placeholder="üîß Diagnostic ID (e.g., DiagnosticOdometerId)" value="DiagnosticOdometerAdjustmentId">
      <button onclick="runGroupOdometer()">üöó Get Group Odometer (CURRENT DATA)</button>
      
      <div id="groupOdometerResult"></div>
    </div>
  </div>

  <script>
    let credentials = null;
    let serverUsed = null;

    function showMessage(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${message}</div>`;
    }

    async function callGeotabAPI(method, params = {}) {
      console.log('callGeotabAPI called with:', { method, params, serverUsed, hasCredentials: !!credentials });
      
      if (!serverUsed) {
        throw new Error('No server specified. Please authenticate first.');
      }
      
      const requestBody = {
        method: method,
        params: credentials ? { ...params, credentials: credentials } : params
      };
      
      console.log('Making fetch request to:', `https://${serverUsed}/apiv1`);
      console.log('Request body:', JSON.stringify(requestBody, null, 2));

      const response = await fetch(`https://${serverUsed}/apiv1`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestBody)
      });

      console.log('Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('Response data:', data);
      
      if (data.error) {
        throw new Error(data.error.message || data.error.name || JSON.stringify(data.error));
      }
      
      return data.result;
    }

    async function authenticate() {
      alert('üî• Authentication function called!');
      console.log('üî• Authentication starting...');
      
      const server = document.getElementById('server').value.trim();
      const database = document.getElementById('database').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      console.log('Auth values:', { server, database, username, hasPassword: !!password });
      
      document.getElementById('authResult').innerHTML = '';
      
      if (!server || !database || !username || !password) {
        showMessage('authResult', '‚ùå Please fill in all fields', 'error');
        return;
      }
      
      try {
        showMessage('authResult', 'üîç Authenticating...', 'warning');
        
        serverUsed = server;
        console.log('Calling Geotab API for authentication...');
        
        const result = await callGeotabAPI('Authenticate', {
          userName: username,
          password: password,
          database: database
        });
        
        console.log('Authentication result:', result);
        
        // Handle server redirect
        if (result.path && result.path !== 'ThisServer') {
          serverUsed = result.path;
          showMessage('authResult', `üîÑ Redirecting to ${result.path}...`, 'warning');
          
          const redirectResult = await callGeotabAPI('Authenticate', {
            userName: username,
            password: password,
            database: database
          });
          
          credentials = redirectResult.credentials;
        } else {
          credentials = result.credentials;
        }
        
        showMessage('authResult', '‚úÖ Authentication successful!', 'success');
        
        console.log('Authentication successful. Credentials stored:', !!credentials);
        console.log('Server used:', serverUsed);
        
        // Update UI
        document.getElementById('connectedServer').textContent = serverUsed;
        document.getElementById('connectedDB').textContent = database;
        document.getElementById('connectedUser').textContent = username;
        document.getElementById('apiSection').style.display = '';
        
      } catch (error) {
        console.error('Authentication error:', error);
        showMessage('authResult', `‚ùå Authentication failed: ${error.message}`, 'error');
      }
    }

    async function runGroupOdometer() {
      if (!credentials) {
        showMessage('groupOdometerResult', '‚ùå Please authenticate first', 'error');
        return;
      }

      const groupId = document.getElementById('groupId').value.trim();
      const diagnosticId = document.getElementById('diagnosticId').value.trim();

      if (!groupId || !diagnosticId) {
        showMessage('groupOdometerResult', '‚ùå Please enter both Group ID and Diagnostic ID', 'error');
        return;
      }

      try {
        showMessage('groupOdometerResult', 'üîç Getting devices from group...', 'warning');

        // Step 1: Get devices from group
        const devices = await callGeotabAPI('Get', {
          typeName: 'Device',
          search: {
            groups: [{ id: groupId }]
          },
          resultsLimit: 50
        });

        if (!devices || devices.length === 0) {
          showMessage('groupOdometerResult', '‚ùå No devices found in group. Check your Group ID.', 'error');
          return;
        }

        showMessage('groupOdometerResult', `‚úÖ Found ${devices.length} devices. Building CURRENT odometer calls...`, 'success');

        // Step 2: Build calls array - CURRENT DATA using same timestamp
        const results = [];
        const calls = [];
        const now = new Date().toISOString(); // Same timestamp for both dates = CURRENT data

        devices.forEach(function(device) {
          results.push({
            deviceId: device.id,
            name: device.name,
            vehicleIdentificationNumber: device.vehicleIdentificationNumber || 'N/A',
            serialNumber: device.serialNumber || 'N/A',
            odometer: null,
            odometerDate: null,
            status: 'Pending'
          });

          calls.push({
            method: 'Get',
            params: {
              typeName: 'StatusData',
              search: {
                fromDate: now,  // SAME timestamp = CURRENT data
                toDate: now,    // SAME timestamp = CURRENT data  
                diagnosticSearch: { id: diagnosticId },
                deviceSearch: { id: device.id }
              },
              resultsLimit: 1
            }
          });
        });

        showMessage('groupOdometerResult', `üöÄ Executing ${calls.length} CURRENT odometer API calls...`, 'warning');
        console.log('üî• FIXED: Using fromDate=now, toDate=now for CURRENT data');

        // Step 3: Execute MultiCall
        const callResults = await callGeotabAPI('ExecuteMultiCall', { calls: calls });

        // Step 4: Process results
        for (let i = 0; i < callResults.length; i++) {
          const statusData = callResults[i] && callResults[i][0];
          if (statusData && statusData.data !== undefined) {
            results[i].odometer = statusData.data;
            results[i].odometerDate = statusData.dateTime;
            results[i].status = statusData.data > 0 ? 'Success' : 'Zero Reading';
          } else {
            results[i].odometer = 'No data';
            results[i].status = 'No Data';
          }
        }

        // Summary statistics
        const withData = results.filter(r => r.odometer && r.odometer !== 'No data' && r.odometer > 0).length;
        const zeroReadings = results.filter(r => r.odometer === 0).length;
        const noData = results.filter(r => r.odometer === 'No data').length;

        // Display results
        showMessage('groupOdometerResult', 
          `‚úÖ Group odometer collection complete!<br>
          üìä <strong>Summary:</strong><br>
          ‚Ä¢ Total vehicles: ${results.length}<br>
          ‚Ä¢ With odometer data: ${withData}<br>
          ‚Ä¢ Zero readings: ${zeroReadings}<br>
          ‚Ä¢ No data: ${noData}`, 'success');

        // Show detailed results
        document.getElementById('groupOdometerResult').innerHTML += 
          `<div class="result">${JSON.stringify(results, null, 2)}</div>`;

      } catch (error) {
        showMessage('groupOdometerResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    console.log('‚úÖ Geotab API Runner loaded successfully!');
    console.log('üîß Authentication function available:', typeof authenticate);
  </script>
</body>
</html>
