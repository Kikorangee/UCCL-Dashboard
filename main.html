<!DOCTYPE html>
<html>
<head>
    <title>UCCL Fleet Dashboard</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .section { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #ddd;
        }
        button { 
            background: #2563eb; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #1d4ed8; }
        input, select, textarea { 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .result { 
            background: #f9f9f9; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px; 
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { color: red; background: #ffe8e8; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .warning { color: orange; background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px; }
        pre { font-size: 12px; white-space: pre-wrap; }
        .debug { background: #f0f8ff; border: 1px solid #ccc; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üöÄ UCCL Fleet Dashboard</h1>
    
    <div class="section">
        <h3>üîç Environment Detection</h3>
        <div id="debugInfo" class="debug">Checking MyGeotab environment...</div>
        <button onclick="checkEnvironment()">üîÑ Refresh Environment Check</button>
    </div>

    <div class="section">
        <h3>üß™ Basic Button Test</h3>
        <button onclick="testBasicButton()">Test Basic Button (No MyGeotab Required)</button>
        <button id="testGeotabButton">Test MyGeotab Button (Requires MyGeotab)</button>
        <div id="testResult"></div>
    </div>

    <div class="section">
        <h3>üîß API Testing</h3>
        
        <select id="method">
            <option value="Get">Get</option>
        </select>
        
        <input id="typeName" placeholder="typeName" value="User">
        
        <textarea id="params" placeholder="Parameters (JSON)" rows="4">{"search":{"name":"%"}}</textarea>
        
        <button id="runApi">üöÄ Run API Call</button>
        <button onclick="testDirectAPI()">üß™ Test Direct API</button>
        
        <div id="apiResult"></div>
    </div>

    <script>
        // Global variables for API access
        let myGeotabAPI = null;
        let myGeotabState = null;

        // Basic button test (no MyGeotab required)
        function testBasicButton() {
            document.getElementById('testResult').innerHTML = '<div class="success">‚úÖ Basic button works! JavaScript is running properly.</div>';
            console.log('Basic button test successful');
        }

        // Environment detection
        function checkEnvironment() {
            const debug = document.getElementById('debugInfo');
            let info = '';
            
            info += 'Current URL: ' + window.location.href + '\n';
            info += 'User Agent: ' + navigator.userAgent + '\n';
            info += 'Window context: ' + (window !== window.parent ? 'iframe' : 'main window') + '\n';
            info += 'Document ready state: ' + document.readyState + '\n';
            info += 'Geotab object available: ' + (typeof geotab !== 'undefined') + '\n';
            
            if (typeof geotab !== 'undefined') {
                info += 'Geotab.addin available: ' + (typeof geotab.addin !== 'undefined') + '\n';
            }
            
            info += 'Current time: ' + new Date().toISOString() + '\n';
            
            debug.textContent = info;
            console.log('Environment check:', info);
        }

        // Test direct API call
        function testDirectAPI() {
            const result = document.getElementById('apiResult');
            
            if (!myGeotabAPI) {
                result.innerHTML = '<div class="error">‚ùå MyGeotab API not available. Add-in may not be properly loaded.</div>';
                return;
            }
            
            try {
                result.innerHTML = '<div class="warning">üîç Testing direct API call...</div>';
                
                myGeotabAPI.call('Get', {
                    typeName: 'User',
                    search: { name: '%' },
                    resultsLimit: 5
                }, 
                function(data) {
                    result.innerHTML = '<div class="success">‚úÖ Direct API test successful! Found ' + data.length + ' users.</div>' +
                                     '<div class="result"><pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
                },
                function(error) {
                    result.innerHTML = '<div class="error">‚ùå Direct API test failed: ' + (error.message || error.name) + '</div>';
                });
                
            } catch (e) {
                result.innerHTML = '<div class="error">‚ùå Exception in direct API test: ' + e.message + '</div>';
            }
        }

        // Initialize environment check on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking environment...');
            checkEnvironment();
            
            // Set up basic button that doesn't require MyGeotab
            const testGeotabBtn = document.getElementById('testGeotabButton');
            if (testGeotabBtn) {
                testGeotabBtn.addEventListener('click', function() {
                    if (typeof geotab === 'undefined') {
                        document.getElementById('testResult').innerHTML = '<div class="error">‚ùå MyGeotab framework not available</div>';
                    } else {
                        document.getElementById('testResult').innerHTML = '<div class="success">‚úÖ MyGeotab framework is available!</div>';
                    }
                });
            }
        });

        // MyGeotab Add-in (only if geotab is available)
        if (typeof geotab !== 'undefined') {
            console.log('Geotab framework detected, setting up add-in...');
            
            geotab.addin.uccldashboard = () => {
                return {
                    initialize(api, state, callback) {
                        console.log('Add-in initializing with API:', !!api);
                        myGeotabAPI = api;
                        myGeotabState = state;
                        
                        // Set up API button
                        setTimeout(() => {
                            const runApiBtn = document.getElementById('runApi');
                            if (runApiBtn) {
                                runApiBtn.addEventListener('click', async function() {
                                    const method = document.getElementById('method').value;
                                    const typeName = document.getElementById('typeName').value.trim();
                                    let params = {};
                                    
                                    const paramsText = document.getElementById('params').value.trim();
                                    if (paramsText) {
                                        try {
                                            params = JSON.parse(paramsText);
                                        } catch (e) {
                                            document.getElementById('apiResult').innerHTML = '<div class="error">Invalid JSON: ' + e.message + '</div>';
                                            return;
                                        }
                                    }
                                    
                                    if (typeName && method !== 'ExecuteMultiCall') {
                                        params.typeName = typeName;
                                    }
                                    
                                    try {
                                        document.getElementById('apiResult').innerHTML = '<div class="warning">Making API call...</div>';
                                        
                                        api.call(method, params, 
                                            function(result) {
                                                const resultCount = Array.isArray(result) ? result.length : (result ? 1 : 0);
                                                document.getElementById('apiResult').innerHTML = 
                                                    '<div class="success">‚úÖ Success! Found ' + resultCount + ' result(s)</div>' +
                                                    '<div class="result"><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
                                            }, 
                                            function(error) {
                                                document.getElementById('apiResult').innerHTML = '<div class="error">‚ùå API call failed: ' + (error.message || error.name) + '</div>';
                                            }
                                        );
                                        
                                    } catch (error) {
                                        document.getElementById('apiResult').innerHTML = '<div class="error">‚ùå Exception: ' + error.message + '</div>';
                                    }
                                });
                                console.log('API button listener added');
                            }
                        }, 100);
                        
                        callback();
                    },
                    
                    focus(api, state) {
                        console.log('Add-in focused');
                        document.getElementById('debugInfo').textContent += '\n‚úÖ Add-in focused successfully at ' + new Date().toISOString();
                    },
                    
                    blur(api, state) {
                        console.log('Add-in blurred');
                    }
                };
            };
        } else {
            console.warn('Geotab framework not available - add-in will not function');
            
            // Show error after page loads
            setTimeout(() => {
                const debugDiv = document.getElementById('debugInfo');
                if (debugDiv) {
                    debugDiv.innerHTML = '<div class="error">‚ùå MyGeotab framework (geotab object) is not available.<br>' +
                                       'This usually means:<br>' +
                                       '‚Ä¢ You\'re viewing this directly on GitHub Pages instead of through MyGeotab<br>' +
                                       '‚Ä¢ The add-in is not properly registered<br>' +
                                       '‚Ä¢ There\'s a configuration issue<br><br>' +
                                       'Please access this through MyGeotab as a registered add-in.</div>';
                }
            }, 1000);
        }
    </script>
</body>
</html>
