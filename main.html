<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UCCL Fleet Dashboard</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 15px; 
      background: #f8f9fa;
    }
    input, button, select, textarea { 
      margin: 4px 0; 
      padding: 8px; 
      width: 100%; 
      box-sizing: border-box; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button { 
      background: #2563eb; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .error { color: #dc2626; background: #fef2f2; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #dc2626; }
    .success { color: #059669; background: #f0fdf4; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #059669; }
    .warning { background: #fef3c7; color: #92400e; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #f59e0b; }
    .result { 
      background: #fff; 
      padding: 0; 
      margin: 8px 0; 
      border-radius: 6px; 
      max-height: 600px; 
      overflow-y: auto; 
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .result-header {
      background: #f8fafc;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      color: #374151;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .result-content {
      padding: 16px;
    }
    .result-json {
      white-space: pre-wrap; 
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      background: #f9fafb;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      max-height: 400px;
      overflow-y: auto;
    }
    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .result-table th {
      background: #f8fafc;
      padding: 8px 12px;
      text-align: left;
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
    }
    .result-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }
    .result-table tr:hover {
      background: #f8fafc;
    }
    .result-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .result-controls button {
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      border-radius: 4px;
      cursor: pointer;
      width: auto;
      margin: 0;
    }
    .result-controls button:hover {
      background: #f3f4f6;
    }
    .result-stats {
      font-size: 12px;
      color: #6b7280;
    }
    .section { 
      background: white;
      border: 1px solid #e5e7eb; 
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    h2 { margin-top: 0; color: #1f2937; font-size: 24px; }
    h3 { margin-top: 0; color: #374151; font-size: 18px; }
    .example-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 10px; 
      margin: 15px 0; 
    }
    .example-btn { 
      padding: 10px 14px; 
      background: #3b82f6; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .example-btn:hover { 
      background: #2563eb; 
      transform: translateY(-1px);
    }
    .category { 
      background: #f8fafc; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 6px; 
      border: 1px solid #e2e8f0;
    }
    .category h4 { 
      margin: 0 0 12px 0; 
      color: #475569; 
      font-size: 16px;
    }
    .header-info {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
  <script>
    geotab.addin.uccldashboard = function(api, state) {
      console.log('üöÄ UCCL Dashboard add-in initializing...');
      console.log('‚úÖ MyGeotab API available:', !!api);
      console.log('‚úÖ MyGeotab state available:', !!state);
      
      let lastApiResult = null;

      function showMessage(elementId, message, type = 'info') {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `<div class="${type}">${message}</div>`;
        }
      }

      // MyGeotab API call function - now using the provided api parameter
      async function callMyGeotabAPI(method, params = {}) {
        return new Promise((resolve, reject) => {
          try {
            console.log(`üìû Making API call: ${method}`, params);
            api.call(method, params, 
              function(result) {
                console.log(`‚úÖ API call successful:`, result);
                resolve(result);
              }, 
              function(error) {
                console.error(`‚ùå API call failed:`, error);
                reject(new Error(error.message || error.name || 'API call failed'));
              }
            );
          } catch (e) {
            console.error(`üí• Exception calling API:`, e);
            reject(new Error('Failed to call MyGeotab API: ' + e.message));
          }
        });
      }

      // Enhanced result display function
      function displayResult(result, method, typeName, containerId = 'apiResult') {
        const container = document.getElementById(containerId);
        if (!container) return;

        const resultCount = Array.isArray(result) ? result.length : (result ? 1 : 0);
        const resultId = 'result_' + Date.now();
        
        // Create result container
        const resultDiv = document.createElement('div');
        resultDiv.className = 'result';
        resultDiv.id = resultId;
        
        // Create header
        const header = document.createElement('div');
        header.className = 'result-header';
        header.innerHTML = `
          <div>
            <strong>${method}</strong> ${typeName ? `‚Ä¢ ${typeName}` : ''} 
            <span class="result-stats">(${resultCount} items)</span>
          </div>
          <div class="result-controls">
            <button onclick="toggleView('${resultId}', 'table')">üìä Table</button>
            <button onclick="toggleView('${resultId}', 'json')">üìù JSON</button>
            <button onclick="copyResult('${resultId}')">üìã Copy</button>
            <button onclick="removeResult('${resultId}')">‚úï</button>
          </div>
        `;
        
        // Create content container
        const content = document.createElement('div');
        content.className = 'result-content';
        
        // Generate table view (default for arrays)
        if (Array.isArray(result) && result.length > 0 && typeof result[0] === 'object') {
          content.appendChild(createTableView(result));
          content.appendChild(createJSONView(result, true)); // hidden initially
        } else {
          content.appendChild(createJSONView(result, false));
        }
        
        resultDiv.appendChild(header);
        resultDiv.appendChild(content);
        container.appendChild(resultDiv);
        
        // Scroll to new result
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // Create table view for array data
      function createTableView(data) {
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-view';
        
        if (!Array.isArray(data) || data.length === 0) {
          tableContainer.innerHTML = '<p>No data to display in table format.</p>';
          return tableContainer;
        }
        
        // Get all unique keys from all objects
        const allKeys = [...new Set(data.flatMap(obj => Object.keys(obj || {})))];
        
        // Limit columns for readability (show most important ones first)
        const priorityKeys = ['id', 'name', 'deviceType', 'serialNumber', 'vehicleIdentificationNumber', 'licensePlate', 'comment'];
        const importantKeys = allKeys.filter(key => priorityKeys.includes(key));
        const otherKeys = allKeys.filter(key => !priorityKeys.includes(key)).slice(0, 5); // limit to 5 more
        const displayKeys = [...importantKeys, ...otherKeys];
        
        const table = document.createElement('table');
        table.className = 'result-table';
        
        // Create header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        displayKeys.forEach(key => {
          const th = document.createElement('th');
          th.textContent = key.charAt(0).toUpperCase() + key.slice(1);
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create body
        const tbody = document.createElement('tbody');
        data.slice(0, 100).forEach(item => { // Limit to 100 rows for performance
          const row = document.createElement('tr');
          displayKeys.forEach(key => {
            const td = document.createElement('td');
            const value = item[key];
            if (value === null || value === undefined) {
              td.textContent = '-';
              td.style.color = '#9ca3af';
            } else if (typeof value === 'object') {
              td.textContent = JSON.stringify(value).substring(0, 50) + '...';
              td.style.fontFamily = 'monospace';
              td.style.fontSize = '11px';
            } else {
              td.textContent = String(value).substring(0, 100);
            }
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        
        if (data.length > 100) {
          const notice = document.createElement('p');
          notice.style.textAlign = 'center';
          notice.style.color = '#6b7280';
          notice.style.fontSize = '12px';
          notice.style.margin = '8px 0';
          notice.textContent = `Showing first 100 of ${data.length} items. Use JSON view to see all data.`;
          tableContainer.appendChild(notice);
        }
        
        tableContainer.appendChild(table);
        return tableContainer;
      }

      // Create JSON view
      function createJSONView(data, hidden = false) {
        const jsonContainer = document.createElement('div');
        jsonContainer.className = 'json-view';
        if (hidden) jsonContainer.style.display = 'none';
        
        const jsonDiv = document.createElement('div');
        jsonDiv.className = 'result-json';
        jsonDiv.textContent = JSON.stringify(data, null, 2);
        
        jsonContainer.appendChild(jsonDiv);
        return jsonContainer;
      }

      // Toggle between table and JSON view
      window.toggleView = function(resultId, viewType) {
        const resultDiv = document.getElementById(resultId);
        if (!resultDiv) return;
        
        const tableView = resultDiv.querySelector('.table-view');
        const jsonView = resultDiv.querySelector('.json-view');
        
        if (viewType === 'table' && tableView) {
          tableView.style.display = 'block';
          if (jsonView) jsonView.style.display = 'none';
        } else if (viewType === 'json' && jsonView) {
          if (tableView) tableView.style.display = 'none';
          jsonView.style.display = 'block';
        }
      };

      // Copy result to clipboard
      window.copyResult = function(resultId) {
        const resultDiv = document.getElementById(resultId);
        if (!resultDiv) return;
        
        const jsonDiv = resultDiv.querySelector('.result-json');
        if (jsonDiv) {
          navigator.clipboard.writeText(jsonDiv.textContent).then(() => {
            // Show temporary feedback
            const button = resultDiv.querySelector('.result-controls button[onclick*="copyResult"]');
            const originalText = button.textContent;
            button.textContent = '‚úÖ Copied!';
            setTimeout(() => {
              button.textContent = originalText;
            }, 1000);
          });
        }
      };

      // Remove result
      window.removeResult = function(resultId) {
        const resultDiv = document.getElementById(resultId);
        if (resultDiv) {
          resultDiv.remove();
        }
      };

      // CSV Download functionality
      function convertToCSV(data, method, typeName) {
        if (!data) return '';
        
        let csvContent = '';
        
        if (Array.isArray(data)) {
          if (data.length === 0) return 'No data available';
          
          // Check if it's Group-based odometer results
          if (lastApiResult.typeName === 'GroupOdometer' && lastApiResult.deviceMapping) {
            csvContent = 'Device_ID,Vehicle_Name,VIN,Serial_Number,Odometer_Reading,Date_Time,Status\n';
            
            lastApiResult.deviceMapping.forEach(function(device) {
              csvContent += `"${device.deviceId}","${device.name}","${device.vehicleIdentificationNumber}","${device.serialNumber}",${device.odometer},"${device.odometerDate || ''}","${device.status}"\n`;
            });
          }
          // Check if it's ExecuteMultiCall results
          else if (method === 'ExecuteMultiCall') {
            csvContent = 'Call_Index,Result_Count,Status,Data\n';
            
            data.forEach((callResult, index) => {
              const resultCount = Array.isArray(callResult) ? callResult.length : (callResult ? 1 : 0);
              csvContent += `${index + 1},${resultCount},Success,"${JSON.stringify(callResult).replace(/"/g, '""')}"\n`;
            });
          } else {
            // Regular array of objects
            const headers = Object.keys(data[0]);
            csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
            
            data.forEach(row => {
              const values = headers.map(header => {
                const value = row[header];
                if (value === null || value === undefined) return '""';
                if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                return `"${String(value).replace(/"/g, '""')}"`;
              });
              csvContent += values.join(',') + '\n';
            });
          }
        } else if (typeof data === 'object') {
          // Single object
          const headers = Object.keys(data);
          csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
          const values = headers.map(header => {
            const value = data[header];
            if (value === null || value === undefined) return '""';
            if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
            return `"${String(value).replace(/"/g, '""')}"`;
          });
          csvContent += values.join(',') + '\n';
        } else {
          csvContent = `"Value"\n"${data}"`;
        }
        
        return csvContent;
      }

      // Clear all results
      window.clearAllResults = function(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
          const results = container.querySelectorAll('.result');
          results.forEach(result => result.remove());
          // Also clear any status messages
          const messages = container.querySelectorAll('.success, .warning, .error');
          messages.forEach(message => message.remove());
        }
      };

      function downloadCSV() {
        if (!lastApiResult) {
          showMessage('apiResult', '‚ö†Ô∏è No data available for download. Run an API call first!', 'warning');
          return;
        }
        
        const csvContent = convertToCSV(lastApiResult.data, lastApiResult.method, lastApiResult.typeName);
        
        if (!csvContent) {
          showMessage('apiResult', '‚ö†Ô∏è No data to export', 'warning');
          return;
        }
        
        // Create filename
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
        const method = lastApiResult.method || 'API';
        const typeName = lastApiResult.typeName || 'Data';
        const filename = `UCCL_${method}_${typeName}_${timestamp}.csv`;
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showMessage('apiResult', `‚úÖ CSV file "${filename}" downloaded successfully!`, 'success');
        } else {
          alert('CSV download not supported in this browser');
        }
      }
        if (!data) return '';
        
        let csvContent = '';
        
        if (Array.isArray(data)) {
          if (data.length === 0) return 'No data available';
          
          // Check if it's Group-based odometer results
          if (lastApiResult.typeName === 'GroupOdometer' && lastApiResult.deviceMapping) {
            csvContent = 'Device_ID,Vehicle_Name,VIN,Serial_Number,Odometer_Reading,Date_Time,Status\n';
            
            lastApiResult.deviceMapping.forEach(function(device) {
              csvContent += `"${device.deviceId}","${device.name}","${device.vehicleIdentificationNumber}","${device.serialNumber}",${device.odometer},"${device.odometerDate || ''}","${device.status}"\n`;
            });
          }
          // Check if it's ExecuteMultiCall results
          else if (method === 'ExecuteMultiCall') {
            csvContent = 'Call_Index,Result_Count,Status,Data\n';
            
            data.forEach((callResult, index) => {
              const resultCount = Array.isArray(callResult) ? callResult.length : (callResult ? 1 : 0);
              csvContent += `${index + 1},${resultCount},Success,"${JSON.stringify(callResult).replace(/"/g, '""')}"\n`;
            });
          } else {
            // Regular array of objects
            const headers = Object.keys(data[0]);
            csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
            
            data.forEach(row => {
              const values = headers.map(header => {
                const value = row[header];
                if (value === null || value === undefined) return '""';
                if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                return `"${String(value).replace(/"/g, '""')}"`;
              });
              csvContent += values.join(',') + '\n';
            });
          }
        } else if (typeof data === 'object') {
          // Single object
          const headers = Object.keys(data);
          csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
          const values = headers.map(header => {
            const value = data[header];
            if (value === null || value === undefined) return '""';
            if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
            return `"${String(value).replace(/"/g, '""')}"`;
          });
          csvContent += values.join(',') + '\n';
        } else {
          csvContent = `"Value"\n"${data}"`;
        }
        
        return csvContent;
      }

      function downloadCSV() {
        if (!lastApiResult) {
          showMessage('apiResult', '‚ö†Ô∏è No data available for download. Run an API call first!', 'warning');
          return;
        }
        
        const csvContent = convertToCSV(lastApiResult.data, lastApiResult.method, lastApiResult.typeName);
        
        if (!csvContent) {
          showMessage('apiResult', '‚ö†Ô∏è No data to export', 'warning');
          return;
        }
        
        // Create filename
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
        const method = lastApiResult.method || 'API';
        const typeName = lastApiResult.typeName || 'Data';
        const filename = `UCCL_${method}_${typeName}_${timestamp}.csv`;
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showMessage('apiResult', `‚úÖ CSV file "${filename}" downloaded successfully!`, 'success');
        } else {
          alert('CSV download not supported in this browser');
        }
      }

      // Load examples
      function loadExample(type) {
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0];
        const lastWeek = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
        
        const examples = {
          // Vehicle & Device Data
          'devices': {
            method: 'Get',
            typeName: 'Device',
            params: '{"resultsLimit": 50}'
          },
          'device-status': {
            method: 'Get',
            typeName: 'DeviceStatusInfo',
            params: '{"resultsLimit": 20}'
          },
          'device-odometer': {
            method: 'Get',
            typeName: 'StatusData',
            params: `{"search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
          },
          'devices-in-group': {
            method: 'Get',
            typeName: 'Device',
            params: '{"search": {"groups": [{"id": "GroupCompanyId"}]}, "resultsLimit": 10}'
          },
          'device-info': {
            method: 'Get',
            typeName: 'Device',
            params: '{"search": {"id": "b1"}}'
          },

          // Location & Trip Data
          'gps-data': {
            method: 'Get',
            typeName: 'LogRecord',
            params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 100}`
          },
          'trips': {
            method: 'Get',
            typeName: 'Trip',
            params: `{"search": {"fromDate": "${lastWeek}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
          },
          'stops': {
            method: 'Get',
            typeName: 'Stop',
            params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
          },
          'zones': {
            method: 'Get',
            typeName: 'Zone',
            params: '{"resultsLimit": 50}'
          },
          'zone-stops': {
            method: 'Get',
            typeName: 'ZoneStop',
            params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
          },

          // Fuel & Engine Data
          'fuel-data': {
            method: 'Get',
            typeName: 'StatusData',
            params: `{"search": {"diagnosticSearch": {"id": "DiagnosticFuelLevelId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
          },
          'engine-data': {
            method: 'Get',
            typeName: 'StatusData',
            params: `{"search": {"diagnosticSearch": {"id": "DiagnosticIgnitionId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
          },
          'fault-data': {
            method: 'Get',
            typeName: 'FaultData',
            params: `{"search": {"fromDate": "${lastWeek}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
          },
          'diagnostics': {
            method: 'Get',
            typeName: 'Diagnostic',
            params: '{"resultsLimit": 100}'
          },

          // Users & Groups
          'users': {
            method: 'Get',
            typeName: 'User',
            params: '{"search": {"name": "%"}}'
          },
          'groups': {
            method: 'Get',
            typeName: 'Group',
            params: '{"search":{"name":"%"}}'
          },
          'driver-changes': {
            method: 'Get',
            typeName: 'DriverChange',
            params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
          },
          'user-details': {
            method: 'Get',
            typeName: 'User',
            params: '{"search": {"name": "francis@directt.co.nz"}}'
          },

          // Maintenance & Reports
          'maintenance': {
            method: 'Get',
            typeName: 'MaintenanceReminder',
            params: '{"resultsLimit": 20}'
          },
          'exceptions': {
            method: 'Get',
            typeName: 'ExceptionEvent',
            params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
          },
          'dvir': {
            method: 'Get',
            typeName: 'DVIRLog',
            params: `{"search": {"fromDate": "${lastWeek}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
          },
          'text-messages': {
            method: 'Get',
            typeName: 'TextMessage',
            params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
          },

          // Advanced Multi-Calls
          'multi-odometer': {
            method: 'ExecuteMultiCall',
            typeName: '',
            params: `{"calls": [{"method": "Get", "params": {"typeName": "StatusData", "search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "deviceSearch": {"id": "b1"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 1}}, {"method": "Get", "params": {"typeName": "StatusData", "search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "deviceSearch": {"id": "b2"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 1}}]}`
          },
          'multi-status': {
            method: 'ExecuteMultiCall',
            typeName: '',
            params: '{"calls": [{"method": "Get", "params": {"typeName": "Device", "resultsLimit": 5}}, {"method": "Get", "params": {"typeName": "User", "resultsLimit": 5}}, {"method": "Get", "params": {"typeName": "Zone", "resultsLimit": 5}}]}'
          },
          'fleet-summary': {
            method: 'ExecuteMultiCall',
            typeName: '',
            params: `{"calls": [{"method": "Get", "params": {"typeName": "Device", "resultsLimit": 1000}}, {"method": "Get", "params": {"typeName": "Trip", "search": {"fromDate": "${today}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 1000}}, {"method": "Get", "params": {"typeName": "ExceptionEvent", "search": {"fromDate": "${today}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 100}}]}`
          }
        };
        
        const example = examples[type];
        if (example) {
          document.getElementById('method').value = example.method;
          document.getElementById('typeName').value = example.typeName;
          document.getElementById('params').value = example.params;
        }
      }

      // Event handlers
      function setupEventHandlers() {
        // API call handler
        document.getElementById('runApi').onclick = async function() {
          const method = document.getElementById('method').value;
          const typeName = document.getElementById('typeName').value.trim();
          let params = {};
          
          const paramsText = document.getElementById('params').value.trim();
          if (paramsText) {
            try {
              params = JSON.parse(paramsText);
            } catch (e) {
              showMessage('apiResult', `‚ùå Invalid JSON: ${e.message}`, 'error');
              return;
            }
          }
          
          if (typeName && method !== 'ExecuteMultiCall') {
            params.typeName = typeName;
          }
          
          try {
            showMessage('apiResult', 'üîç Making API call...', 'warning');
            
            const result = await callMyGeotabAPI(method, params);
            
            const resultCount = Array.isArray(result) ? result.length : (result ? 1 : 0);
            showMessage('apiResult', `‚úÖ Success! Found ${resultCount} result(s)`, 'success');
            
            // Use enhanced display function
            displayResult(result, method, typeName, 'apiResult');
            
            // Store result for CSV download
            lastApiResult = {
              method: method,
              typeName: typeName,
              data: result,
              timestamp: new Date().toISOString()
            };
            
          } catch (error) {
            showMessage('apiResult', `‚ùå API call failed: ${error.message}`, 'error');
            console.error('API call error:', error);
          }
        };

        // CSV download handler
        document.getElementById('downloadCsv').onclick = downloadCSV;

        // Group-based odometer collection
        document.getElementById('runGroupOdometer').onclick = async function() {
          const groupId = document.getElementById('groupId').value.trim();
          const diagnosticId = document.getElementById('diagnosticId').value.trim();

          if (!groupId || !diagnosticId) {
            showMessage('groupOdometerResult', '‚ùå Please enter both Group ID and Diagnostic ID', 'error');
            return;
          }

          try {
            showMessage('groupOdometerResult', 'üîç Getting devices from group...', 'warning');

            // Step 1: Get devices from group
            const devices = await callMyGeotabAPI('Get', {
              typeName: 'Device',
              search: {
                groups: [{ id: groupId }]
              },
              resultsLimit: 1000
            });

            if (!devices || devices.length === 0) {
              showMessage('groupOdometerResult', '‚ùå No devices found in group. Check your Group ID.', 'error');
              return;
            }

            showMessage('groupOdometerResult', `‚úÖ Found ${devices.length} devices. Building odometer calls...`, 'success');

            // Step 2: Build calls array
            const results = [];
            const calls = [];
            const now = new Date().toISOString();
            const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString();

            devices.forEach(function(device) {
              results.push({
                deviceId: device.id,
                name: device.name,
                vehicleIdentificationNumber: device.vehicleIdentificationNumber || 'N/A',
                serialNumber: device.serialNumber || 'N/A',
                odometer: null,
                odometerDate: null,
                status: 'Pending'
              });

              calls.push({
                method: 'Get',
                params: {
                  typeName: 'StatusData',
                  search: {
                    fromDate: yesterday,
                    toDate: now,
                    diagnosticSearch: { id: diagnosticId },
                    deviceSearch: { id: device.id }
                  },
                  resultsLimit: 1
                }
              });
            });

            showMessage('groupOdometerResult', `üöÄ Executing ${calls.length} odometer API calls...`, 'warning');

            // Step 3: Execute MultiCall
            const callResults = await callMyGeotabAPI('ExecuteMultiCall', { calls: calls });

            // Step 4: Process results
            for (let i = 0; i < callResults.length; i++) {
              const statusData = callResults[i] && callResults[i][0];
              if (statusData && statusData.data !== undefined) {
                results[i].odometer = statusData.data;
                results[i].odometerDate = statusData.dateTime;
                results[i].status = statusData.data > 0 ? 'Success' : 'Zero Reading';
              } else {
                results[i].odometer = 'No data';
                results[i].status = 'No Data';
              }
            }

            // Summary statistics
            const withData = results.filter(r => r.odometer && r.odometer !== 'No data' && r.odometer > 0).length;
            const zeroReadings = results.filter(r => r.odometer === 0).length;
            const noData = results.filter(r => r.odometer === 'No data').length;

            // Display results
            showMessage('groupOdometerResult', 
              `‚úÖ Group odometer collection complete!<br>
              üìä <strong>Summary:</strong><br>
              ‚Ä¢ Total vehicles: ${results.length}<br>
              ‚Ä¢ With odometer data: ${withData}<br>
              ‚Ä¢ Zero readings: ${zeroReadings}<br>
              ‚Ä¢ No data: ${noData}`, 'success');

            // Store results for CSV download
            lastApiResult = {
              method: 'ExecuteMultiCall',
              typeName: 'GroupOdometer',
              data: callResults,
              timestamp: new Date().toISOString(),
              deviceMapping: results
            };

            // Show detailed results with enhanced display
            displayResult(results, 'Group Odometer Collection', 'Summary', 'groupOdometerResult');

          } catch (error) {
            showMessage('groupOdometerResult', `‚ùå Error: ${error.message}`, 'error');
          }
        };

        // Example button handlers
        window.loadExample = loadExample;
      }

      // MyGeotab add-in lifecycle methods
      return {
        initialize: function(api, state, callback) {
          console.log('üîß UCCL Dashboard initializing...');
          
          // Setup event handlers once DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventHandlers);
          } else {
            setupEventHandlers();
          }
          
          // Signal that initialization is complete
          callback();
        },
        
        focus: function(api, state) {
          console.log('üéØ UCCL Dashboard focused');
          
          // Show success message when add-in becomes active
          showMessage('apiResult', '‚úÖ Connected to MyGeotab API successfully! Ready to use all features.', 'success');
          
          // Clear message after 3 seconds
          setTimeout(() => {
            const apiResultElement = document.getElementById('apiResult');
            if (apiResultElement && apiResultElement.innerHTML.includes('Connected to MyGeotab API successfully')) {
              apiResultElement.innerHTML = '';
            }
          }, 3000);
        },
        
        blur: function(api, state) {
          console.log('üì§ UCCL Dashboard blurred');
          // Clean up if needed when add-in loses focus
        }
      };
    };
  </script>
</head>
<body>
  <div class="header-info">
    <h2>üöÄ UCCL Fleet Dashboard</h2>
    <p><span class="status-indicator"></span>Connected to MyGeotab ‚Ä¢ Enhanced API Tool with 20+ Pre-built Calls</p>
  </div>

  <div class="section">
    <h3>üîß API Testing</h3>
    
    <select id="method">
      <option value="Get">Get</option>
      <option value="Add">Add</option>
      <option value="Set">Set</option>
      <option value="Remove">Remove</option>
      <option value="ExecuteMultiCall">ExecuteMultiCall</option>
    </select>
    
    <input id="typeName" placeholder="typeName" value="User">
    
    <textarea id="params" placeholder='Parameters (JSON)' rows="6">{"search":{"name":"%"}}</textarea>
    
    <div style="display: flex; gap: 8px; margin: 8px 0;">
      <button id="runApi" style="background: #059669; flex: 1;">üöÄ Run API Call</button>
      <button id="downloadCsv" style="background: #0891b2; flex: 1;">üìä Download CSV</button>
      <button onclick="clearAllResults('apiResult')" style="background: #6b7280; width: auto; padding: 8px 16px;">üóëÔ∏è Clear</button>
    </div>
    
    <div id="apiResult"></div>
  </div>

  <div class="section">
    <h3>üè¢ Group-Based Odometer Collection</h3>
    <div class="warning">
      <strong>üìù Instructions:</strong><br>
      1. First get your Group ID and Diagnostic ID using the examples below<br>
      2. Enter them here and click "Get Group Odometer Readings"
    </div>
    <input id="groupId" placeholder="Group ID (e.g., GroupCompanyId)" value="GroupCompanyId">
    <input id="diagnosticId" placeholder="Diagnostic ID (e.g., DiagnosticOdometerId)" value="DiagnosticOdometerAdjustmentId">
    <div style="display: flex; gap: 8px; margin: 8px 0;">
      <button id="runGroupOdometer" style="background: #059669; flex: 1;">üöó Get Group Odometer Readings</button>
      <button onclick="clearAllResults('groupOdometerResult')" style="background: #6b7280; width: auto; padding: 8px 16px;">üóëÔ∏è Clear</button>
    </div>
    <div id="groupOdometerResult"></div>
  </div>

  <div class="section">
    <h3>üìã Quick API Examples</h3>
    
    <div class="category">
      <h4>üöó Vehicle & Device Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('devices')">Get All Devices</button>
        <button class="example-btn" onclick="loadExample('device-status')">Get Device Status</button>
        <button class="example-btn" onclick="loadExample('device-odometer')">Get Device Odometer</button>
        <button class="example-btn" onclick="loadExample('devices-in-group')">Get Devices in Group</button>
        <button class="example-btn" onclick="loadExample('device-info')">Get Device Details</button>
      </div>
    </div>

    <div class="category">
      <h4>üìç Location & Trip Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('gps-data')">Get GPS Data</button>
        <button class="example-btn" onclick="loadExample('trips')">Get Recent Trips</button>
        <button class="example-btn" onclick="loadExample('stops')">Get Stops</button>
        <button class="example-btn" onclick="loadExample('zones')">Get All Zones</button>
        <button class="example-btn" onclick="loadExample('zone-stops')">Get Zone Stops</button>
      </div>
    </div>

    <div class="category">
      <h4>‚õΩ Fuel & Engine Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('fuel-data')">Get Fuel Data</button>
        <button class="example-btn" onclick="loadExample('engine-data')">Get Engine Status</button>
        <button class="example-btn" onclick="loadExample('fault-data')">Get Fault Data</button>
        <button class="example-btn" onclick="loadExample('diagnostics')">Get All Diagnostics</button>
      </div>
    </div>

    <div class="category">
      <h4>üë• Users & Groups</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('users')">Get All Users</button>
        <button class="example-btn" onclick="loadExample('groups')">Get All Groups</button>
        <button class="example-btn" onclick="loadExample('diagnostics')">Get Odometer Diagnostics</button>
        <button class="example-btn" onclick="loadExample('driver-changes')">Get Driver Changes</button>
        <button class="example-btn" onclick="loadExample('user-details')">Get User Details</button>
      </div>
    </div>

    <div class="category">
      <h4>üîß Maintenance & Reports</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('maintenance')">Get Maintenance</button>
        <button class="example-btn" onclick="loadExample('exceptions')">Get Exceptions</button>
        <button class="example-btn" onclick="loadExample('dvir')">Get DVIR Logs</button>
        <button class="example-btn" onclick="loadExample('text-messages')">Get Text Messages</button>
      </div>
    </div>

    <div class="category">
      <h4>‚ö° Advanced Multi-Calls</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('multi-odometer')">Multi-Device Odometer</button>
        <button class="example-btn" onclick="loadExample('multi-status')">Multi-Device Status</button>
        <button class="example-btn" onclick="loadExample('fleet-summary')">Fleet Summary</button>
      </div>
    </div>
  </div>
</body>
</html>
