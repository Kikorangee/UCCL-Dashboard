<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UCCL Fleet Dashboard</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 15px; 
      background: #f8f9fa;
    }
    input, button, select, textarea { 
      margin: 4px 0; 
      padding: 8px; 
      width: 100%; 
      box-sizing: border-box; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button { 
      background: #2563eb; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .error { color: #dc2626; background: #fef2f2; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #dc2626; }
    .success { color: #059669; background: #f0fdf4; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #059669; }
    .warning { background: #fef3c7; color: #92400e; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #f59e0b; }
    .result { 
      white-space: pre-wrap; 
      background: #fff; 
      padding: 12px; 
      margin: 8px 0; 
      border-radius: 6px; 
      max-height: 400px; 
      overflow-y: auto; 
      border: 1px solid #e5e7eb;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }
    .section { 
      background: white;
      border: 1px solid #e5e7eb; 
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    h2 { margin-top: 0; color: #1f2937; font-size: 24px; }
    h3 { margin-top: 0; color: #374151; font-size: 18px; }
    .example-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 10px; 
      margin: 15px 0; 
    }
    .example-btn { 
      padding: 10px 14px; 
      background: #3b82f6; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .example-btn:hover { 
      background: #2563eb; 
      transform: translateY(-1px);
    }
    .category { 
      background: #f8fafc; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 6px; 
      border: 1px solid #e2e8f0;
    }
    .category h4 { 
      margin: 0 0 12px 0; 
      color: #475569; 
      font-size: 16px;
    }
    .header-info {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="header-info">
    <h2>üöÄ UCCL Fleet Dashboard</h2>
    <p><span class="status-indicator"></span>Connected to MyGeotab ‚Ä¢ Enhanced API Tool with 20+ Pre-built Calls</p>
    <div id="debugInfo" style="margin-top: 10px; font-size: 12px; opacity: 0.8; display: none;">
      <strong>Debug Info:</strong> <span id="debugText">Initializing...</span><br>
      <button onclick="toggleDebug()" style="margin-top: 5px; margin-right: 10px; padding: 2px 6px; font-size: 11px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; cursor: pointer;">Hide Debug</button>
      <button onclick="discoverAllAPIs()" style="margin-right: 10px; padding: 2px 6px; font-size: 11px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; cursor: pointer;">üîç Scan APIs</button>
      <button onclick="console.clear()" style="padding: 2px 6px; font-size: 11px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; cursor: pointer;">üßπ Clear Console</button>
    </div>
    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">
      <button onclick="toggleDebug()" style="padding: 2px 6px; font-size: 10px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer;">üîß Debug Tools</button>
      <span style="margin-left: 10px;">Environment: <span id="environmentInfo">Loading...</span></span>
    </div>
  </div>

  <div class="section">
    <h3>üîß API Testing</h3>
    
    <select id="method">
      <option value="Get">Get</option>
      <option value="Add">Add</option>
      <option value="Set">Set</option>
      <option value="Remove">Remove</option>
      <option value="ExecuteMultiCall">ExecuteMultiCall</option>
    </select>
    
    <input id="typeName" placeholder="typeName" value="User">
    
    <textarea id="params" placeholder='Parameters (JSON)' rows="6">{"search":{"name":"%"}}</textarea>
    
    <button id="runApi" style="background: #059669;">üöÄ Run API Call</button>
    <button id="downloadCsv" style="background: #0891b2;">üìä Download CSV</button>
    
    <div id="apiResult"></div>
  </div>

  <div class="section">
    <h3>üè¢ Group-Based Odometer Collection</h3>
    <div class="warning">
      <strong>üìù Instructions:</strong><br>
      1. First get your Group ID and Diagnostic ID using the examples below<br>
      2. Enter them here and click "Get Group Odometer Readings"
    </div>
    <input id="groupId" placeholder="Group ID (e.g., GroupCompanyId)" value="GroupCompanyId">
    <input id="diagnosticId" placeholder="Diagnostic ID (e.g., DiagnosticOdometerId)" value="DiagnosticOdometerAdjustmentId">
    <button id="runGroupOdometer" style="background: #059669;">üöó Get Group Odometer Readings</button>
    <div id="groupOdometerResult"></div>
  </div>

  <div class="section">
    <h3>üìã Quick API Examples</h3>
    
    <div class="category">
      <h4>üöó Vehicle & Device Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('devices')">Get All Devices</button>
        <button class="example-btn" onclick="loadExample('device-status')">Get Device Status</button>
        <button class="example-btn" onclick="loadExample('device-odometer')">Get Device Odometer</button>
        <button class="example-btn" onclick="loadExample('devices-in-group')">Get Devices in Group</button>
        <button class="example-btn" onclick="loadExample('device-info')">Get Device Details</button>
      </div>
    </div>

    <div class="category">
      <h4>üìç Location & Trip Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('gps-data')">Get GPS Data</button>
        <button class="example-btn" onclick="loadExample('trips')">Get Recent Trips</button>
        <button class="example-btn" onclick="loadExample('stops')">Get Stops</button>
        <button class="example-btn" onclick="loadExample('zones')">Get All Zones</button>
        <button class="example-btn" onclick="loadExample('zone-stops')">Get Zone Stops</button>
      </div>
    </div>

    <div class="category">
      <h4>‚õΩ Fuel & Engine Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('fuel-data')">Get Fuel Data</button>
        <button class="example-btn" onclick="loadExample('engine-data')">Get Engine Status</button>
        <button class="example-btn" onclick="loadExample('fault-data')">Get Fault Data</button>
        <button class="example-btn" onclick="loadExample('diagnostics')">Get All Diagnostics</button>
      </div>
    </div>

    <div class="category">
      <h4>üë• Users & Groups</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('users')">Get All Users</button>
        <button class="example-btn" onclick="loadExample('groups')">Get All Groups</button>
        <button class="example-btn" onclick="loadExample('diagnostics')">Get Odometer Diagnostics</button>
        <button class="example-btn" onclick="loadExample('driver-changes')">Get Driver Changes</button>
        <button class="example-btn" onclick="loadExample('user-details')">Get User Details</button>
      </div>
    </div>

    <div class="category">
      <h4>üîß Maintenance & Reports</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('maintenance')">Get Maintenance</button>
        <button class="example-btn" onclick="loadExample('exceptions')">Get Exceptions</button>
        <button class="example-btn" onclick="loadExample('dvir')">Get DVIR Logs</button>
        <button class="example-btn" onclick="loadExample('text-messages')">Get Text Messages</button>
      </div>
    </div>

    <div class="category">
      <h4>‚ö° Advanced Multi-Calls</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('multi-odometer')">Multi-Device Odometer</button>
        <button class="example-btn" onclick="loadExample('multi-status')">Multi-Device Status</button>
        <button class="example-btn" onclick="loadExample('fleet-summary')">Fleet Summary</button>
      </div>
    </div>
  </div>

  <script>
    let lastApiResult = null;
    let isApiReady = false;
    let apiObject = null;
    let initializationAttempts = 0;
    const maxAttempts = 100; // 10 seconds total

    function showMessage(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `<div class="${type}">${message}</div>`;
      }
    }

    // Debug function to show what's available
    function debugAPISearch() {
      const debug = {
        'window.api': typeof window.api,
        'window.parent.api': window.parent ? typeof window.parent.api : 'no parent',
        'window.top.api': window.top ? typeof window.top.api : 'no top',
        'global api': typeof api,
        'window.GeotabApi': typeof window.GeotabApi,
        'window.parent.GeotabApi': window.parent ? typeof window.parent.GeotabApi : 'no parent',
        'window.geotab': typeof window.geotab,
        'window.parent.geotab': window.parent ? typeof window.parent.geotab : 'no parent'
      };
      console.log('API Debug Info:', debug);
      return debug;
    }

    // Debug toggle function
    window.toggleDebug = function() {
      const debugDiv = document.getElementById('debugInfo');
      if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
        updateDebugInfo();
      } else {
        debugDiv.style.display = 'none';
      }
    };

    // Update debug information
    function updateDebugInfo() {
      const debugElement = document.getElementById('debugText');
      if (debugElement) {
        const info = {
          ready: isApiReady,
          apiFound: !!apiObject,
          attempts: initializationAttempts,
          location: window.location.href,
          parentAvailable: !!window.parent,
          topAvailable: !!window.top,
          iframe: window !== window.parent
        };
        debugElement.textContent = JSON.stringify(info, null, 1);
      }
    }

    // Enhanced API detection for MyGeotab iframe environment
    function findAPIObject() {
      // Try multiple possible API locations and names
      const possibleAPIs = [
        // Direct window access
        () => window.api,
        () => window.GeotabApi,
        () => window.geotab,
        () => window.myGeotabApi,
        
        // Parent window access
        () => window.parent && window.parent.api,
        () => window.parent && window.parent.GeotabApi,
        () => window.parent && window.parent.geotab,
        () => window.parent && window.parent.myGeotabApi,
        
        // Top window access
        () => window.top && window.top !== window && window.top.api,
        () => window.top && window.top !== window && window.top.GeotabApi,
        () => window.top && window.top !== window && window.top.geotab,
        
        // Global scope
        () => typeof api !== 'undefined' ? api : null,
        () => typeof GeotabApi !== 'undefined' ? GeotabApi : null,
        () => typeof geotab !== 'undefined' ? geotab : null
      ];

      for (let i = 0; i < possibleAPIs.length; i++) {
        try {
          const foundAPI = possibleAPIs[i]();
          if (foundAPI && foundAPI.call && typeof foundAPI.call === 'function') {
            console.log(`API found at location ${i}:`, foundAPI);
            return foundAPI;
          }
        } catch (e) {
          // Security error accessing parent/top, continue
          continue;
        }
      }
      return null;
    }

    function waitForAPI() {
      return new Promise((resolve) => {
        const checkAPI = () => {
          initializationAttempts++;
          
          // Debug every 10 attempts
          if (initializationAttempts % 10 === 0) {
            debugAPISearch();
          }

          const foundAPI = findAPIObject();

          if (foundAPI) {
            apiObject = foundAPI;
            isApiReady = true;
            console.log('MyGeotab API found and ready:', foundAPI);
            updateDebugInfo();
            resolve(foundAPI);
            return;
          }

          // Continue checking if we haven't exceeded max attempts
          if (initializationAttempts < maxAttempts) {
            // Update debug info periodically
            if (initializationAttempts % 20 === 0) {
              updateDebugInfo();
            }
            setTimeout(checkAPI, 100);
          } else {
            console.warn('MyGeotab API not found after maximum attempts');
            debugAPISearch(); // Final debug output
            updateDebugInfo();
            resolve(null);
          }
        };

        checkAPI();
      });
    }

    // Event-based API detection (in case API loads after page)
    function setupAPIEventListeners() {
      // Listen for potential MyGeotab events
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'api-ready') {
          console.log('API ready event received');
          const foundAPI = findAPIObject();
          if (foundAPI && !isApiReady) {
            apiObject = foundAPI;
            isApiReady = true;
            showMessage('apiResult', '‚úÖ MyGeotab API connected via event!', 'success');
          }
        }
      });

      // Check if API becomes available on window load
      window.addEventListener('load', function() {
        if (!isApiReady) {
          setTimeout(() => {
            const foundAPI = findAPIObject();
            if (foundAPI) {
              apiObject = foundAPI;
              isApiReady = true;
              showMessage('apiResult', '‚úÖ MyGeotab API connected on window load!', 'success');
            }
          }, 1000);
        }
      });
    }

    // Manual retry function for users
    window.retryAPIConnection = function() {
      isApiReady = false;
      apiObject = null;
      initializationAttempts = 0;
      showMessage('apiResult', 'üîÑ Retrying API connection...', 'warning');
      updateDebugInfo();
      
      waitForAPI().then(api => {
        updateDebugInfo();
        if (api) {
          showMessage('apiResult', '‚úÖ MyGeotab API connected successfully!', 'success');
          // Update status indicators
          const statusElements = document.querySelectorAll('.status-indicator');
          statusElements.forEach(el => {
            if (el) {
              el.style.background = '#10b981'; // Green
            }
          });
        } else {
          showMessage('apiResult', '‚ùå Still unable to connect to MyGeotab API. Try refreshing the page.', 'error');
        }
      });
    };

    // MyGeotab API call function with enhanced error handling
    async function callMyGeotabAPI(method, params = {}) {
      if (!isApiReady || !apiObject) {
        // Try to find API again
        const foundAPI = findAPIObject();
        if (foundAPI) {
          apiObject = foundAPI;
          isApiReady = true;
        } else {
          throw new Error('MyGeotab API is not available. Click "Retry Connection" or refresh the page.');
        }
      }

      return new Promise((resolve, reject) => {
        try {
          apiObject.call(method, params, 
            function(result) {
              resolve(result);
            }, 
            function(error) {
              reject(new Error(error.message || error.name || JSON.stringify(error) || 'API call failed'));
            }
          );
        } catch (e) {
          reject(new Error('Failed to call MyGeotab API: ' + e.message));
        }
      });
    }

    // API call handler with comprehensive error handling
    document.getElementById('runApi').onclick = async function() {
      if (!isApiReady || !apiObject) {
        // Try to find API one more time
        const foundAPI = findWorkingAPI();
        if (foundAPI) {
          apiObject = foundAPI;
          isApiReady = true;
          showMessage('apiResult', '‚úÖ MyGeotab API found! Proceeding with call...', 'success');
        } else {
          showMessage('apiResult', 
            '‚ùå MyGeotab API not ready. Try "Retry Discovery" first.<br>' +
            '<button onclick="retryAPIConnection()" style="margin-left: 10px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Retry Discovery</button> ' +
            '<button onclick="enableTestMode()" style="margin-left: 5px; padding: 4px 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">üß™ Test Mode</button>', 
            'error'
          );
          return;
        }
      }

      const method = document.getElementById('method').value;
      const typeName = document.getElementById('typeName').value.trim();
      let params = {};
      
      const paramsText = document.getElementById('params').value.trim();
      if (paramsText) {
        try {
          params = JSON.parse(paramsText);
        } catch (e) {
          showMessage('apiResult', `‚ùå Invalid JSON: ${e.message}`, 'error');
          return;
        }
      }
      
      if (typeName && method !== 'ExecuteMultiCall') {
        params.typeName = typeName;
      }
      
      try {
        showMessage('apiResult', 'üîç Making API call...', 'warning');
        
        const result = await callMyGeotabAPI(method, params);
        
        const resultCount = Array.isArray(result) ? result.length : (result ? 1 : 0);
        showMessage('apiResult', `‚úÖ Success! Found ${resultCount} result(s)`, 'success');
        document.getElementById('apiResult').innerHTML += `<div class="result">${JSON.stringify(result, null, 2)}</div>`;
        
        // Store result for CSV download
        lastApiResult = {
          method: method,
          typeName: typeName,
          data: result,
          timestamp: new Date().toISOString()
        };
        
      } catch (error) {
        showMessage('apiResult', `‚ùå API call failed: ${error.message}`, 'error');
        console.error('API call error:', error);
      }
    };

    // CSV Download functionality
    function convertToCSV(data, method, typeName) {
      if (!data) return '';
      
      let csvContent = '';
      
      if (Array.isArray(data)) {
        if (data.length === 0) return 'No data available';
        
        // Check if it's Group-based odometer results
        if (lastApiResult.typeName === 'GroupOdometer' && lastApiResult.deviceMapping) {
          csvContent = 'Device_ID,Vehicle_Name,VIN,Serial_Number,Odometer_Reading,Date_Time,Status\n';
          
          lastApiResult.deviceMapping.forEach(function(device) {
            csvContent += `"${device.deviceId}","${device.name}","${device.vehicleIdentificationNumber}","${device.serialNumber}",${device.odometer},"${device.odometerDate || ''}","${device.status}"\n`;
          });
        }
        // Check if it's ExecuteMultiCall results
        else if (method === 'ExecuteMultiCall') {
          csvContent = 'Call_Index,Result_Count,Status,Data\n';
          
          data.forEach((callResult, index) => {
            const resultCount = Array.isArray(callResult) ? callResult.length : (callResult ? 1 : 0);
            csvContent += `${index + 1},${resultCount},Success,"${JSON.stringify(callResult).replace(/"/g, '""')}"\n`;
          });
        } else {
          // Regular array of objects
          const headers = Object.keys(data[0]);
          csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
          
          data.forEach(row => {
            const values = headers.map(header => {
              const value = row[header];
              if (value === null || value === undefined) return '""';
              if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
              return `"${String(value).replace(/"/g, '""')}"`;
            });
            csvContent += values.join(',') + '\n';
          });
        }
      } else if (typeof data === 'object') {
        // Single object
        const headers = Object.keys(data);
        csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
        const values = headers.map(header => {
          const value = data[header];
          if (value === null || value === undefined) return '""';
          if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
          return `"${String(value).replace(/"/g, '""')}"`;
        });
        csvContent += values.join(',') + '\n';
      } else {
        csvContent = `"Value"\n"${data}"`;
      }
      
      return csvContent;
    }

    function downloadCSV() {
      if (!lastApiResult) {
        showMessage('apiResult', '‚ö†Ô∏è No data available for download. Run an API call first!', 'warning');
        return;
      }
      
      const csvContent = convertToCSV(lastApiResult.data, lastApiResult.method, lastApiResult.typeName);
      
      if (!csvContent) {
        showMessage('apiResult', '‚ö†Ô∏è No data to export', 'warning');
        return;
      }
      
      // Create filename
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
      const method = lastApiResult.method || 'API';
      const typeName = lastApiResult.typeName || 'Data';
      const filename = `UCCL_${method}_${typeName}_${timestamp}.csv`;
      
      // Create and download file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage('apiResult', `‚úÖ CSV file "${filename}" downloaded successfully!`, 'success');
      } else {
        alert('CSV download not supported in this browser');
      }
    }

    document.getElementById('downloadCsv').onclick = downloadCSV;

    // Group-based odometer collection
    document.getElementById('runGroupOdometer').onclick = async function() {
      if (!isApiReady) {
        showMessage('groupOdometerResult', '‚ùå MyGeotab API not ready. Please wait for initialization...', 'error');
        return;
      }

      const groupId = document.getElementById('groupId').value.trim();
      const diagnosticId = document.getElementById('diagnosticId').value.trim();

      if (!groupId || !diagnosticId) {
        showMessage('groupOdometerResult', '‚ùå Please enter both Group ID and Diagnostic ID', 'error');
        return;
      }

      try {
        showMessage('groupOdometerResult', 'üîç Getting devices from group...', 'warning');

        // Step 1: Get devices from group
        const devices = await callMyGeotabAPI('Get', {
          typeName: 'Device',
          search: {
            groups: [{ id: groupId }]
          },
          resultsLimit: 1000
        });

        if (!devices || devices.length === 0) {
          showMessage('groupOdometerResult', '‚ùå No devices found in group. Check your Group ID.', 'error');
          return;
        }

        showMessage('groupOdometerResult', `‚úÖ Found ${devices.length} devices. Building odometer calls...`, 'success');

        // Step 2: Build calls array
        const results = [];
        const calls = [];
        const now = new Date().toISOString();
        const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString();

        devices.forEach(function(device) {
          results.push({
            deviceId: device.id,
            name: device.name,
            vehicleIdentificationNumber: device.vehicleIdentificationNumber || 'N/A',
            serialNumber: device.serialNumber || 'N/A',
            odometer: null,
            odometerDate: null,
            status: 'Pending'
          });

          calls.push({
            method: 'Get',
            params: {
              typeName: 'StatusData',
              search: {
                fromDate: yesterday,
                toDate: now,
                diagnosticSearch: { id: diagnosticId },
                deviceSearch: { id: device.id }
              },
              resultsLimit: 1
            }
          });
        });

        showMessage('groupOdometerResult', `üöÄ Executing ${calls.length} odometer API calls...`, 'warning');

        // Step 3: Execute MultiCall
        const callResults = await callMyGeotabAPI('ExecuteMultiCall', { calls: calls });

        // Step 4: Process results
        for (let i = 0; i < callResults.length; i++) {
          const statusData = callResults[i] && callResults[i][0];
          if (statusData && statusData.data !== undefined) {
            results[i].odometer = statusData.data;
            results[i].odometerDate = statusData.dateTime;
            results[i].status = statusData.data > 0 ? 'Success' : 'Zero Reading';
          } else {
            results[i].odometer = 'No data';
            results[i].status = 'No Data';
          }
        }

        // Summary statistics
        const withData = results.filter(r => r.odometer && r.odometer !== 'No data' && r.odometer > 0).length;
        const zeroReadings = results.filter(r => r.odometer === 0).length;
        const noData = results.filter(r => r.odometer === 'No data').length;

        // Display results
        showMessage('groupOdometerResult', 
          `‚úÖ Group odometer collection complete!<br>
          üìä <strong>Summary:</strong><br>
          ‚Ä¢ Total vehicles: ${results.length}<br>
          ‚Ä¢ With odometer data: ${withData}<br>
          ‚Ä¢ Zero readings: ${zeroReadings}<br>
          ‚Ä¢ No data: ${noData}`, 'success');

        // Store results for CSV download
        lastApiResult = {
          method: 'ExecuteMultiCall',
          typeName: 'GroupOdometer',
          data: callResults,
          timestamp: new Date().toISOString(),
          deviceMapping: results
        };

        // Show detailed results
        document.getElementById('groupOdometerResult').innerHTML += 
          `<div class="result">${JSON.stringify(results, null, 2)}</div>`;

      } catch (error) {
        showMessage('groupOdometerResult', `‚ùå Error: ${error.message}`, 'error');
      }
    };

    // Load examples
    function loadExample(type) {
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0];
      const lastWeek = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
      
      const examples = {
        // Vehicle & Device Data
        'devices': {
          method: 'Get',
          typeName: 'Device',
          params: '{"resultsLimit": 50}'
        },
        'device-status': {
          method: 'Get',
          typeName: 'DeviceStatusInfo',
          params: '{"resultsLimit": 20}'
        },
        'device-odometer': {
          method: 'Get',
          typeName: 'StatusData',
          params: `{"search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
        },
        'devices-in-group': {
          method: 'Get',
          typeName: 'Device',
          params: '{"search": {"groups": [{"id": "GroupCompanyId"}]}, "resultsLimit": 10}'
        },
        'device-info': {
          method: 'Get',
          typeName: 'Device',
          params: '{"search": {"id": "b1"}}'
        },

        // Location & Trip Data
        'gps-data': {
          method: 'Get',
          typeName: 'LogRecord',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 100}`
        },
        'trips': {
          method: 'Get',
          typeName: 'Trip',
          params: `{"search": {"fromDate": "${lastWeek}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },
        'stops': {
          method: 'Get',
          typeName: 'Stop',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
        },
        'zones': {
          method: 'Get',
          typeName: 'Zone',
          params: '{"resultsLimit": 50}'
        },
        'zone-stops': {
          method: 'Get',
          typeName: 'ZoneStop',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },

        // Fuel & Engine Data
        'fuel-data': {
          method: 'Get',
          typeName: 'StatusData',
          params: `{"search": {"diagnosticSearch": {"id": "DiagnosticFuelLevelId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
        },
        'engine-data': {
          method: 'Get',
          typeName: 'StatusData',
          params: `{"search": {"diagnosticSearch": {"id": "DiagnosticIgnitionId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
        },
        'fault-data': {
          method: 'Get',
          typeName: 'FaultData',
          params: `{"search": {"fromDate": "${lastWeek}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },
        'diagnostics': {
          method: 'Get',
          typeName: 'Diagnostic',
          params: '{"resultsLimit": 100}'
        },

        // Users & Groups
        'users': {
          method: 'Get',
          typeName: 'User',
          params: '{"search": {"name": "%"}}'
        },
        'groups': {
          method: 'Get',
          typeName: 'Group',
          params: '{"search":{"name":"%"}}'
        },
        'driver-changes': {
          method: 'Get',
          typeName: 'DriverChange',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
        },
        'user-details': {
          method: 'Get',
          typeName: 'User',
          params: '{"search": {"name": "francis@directt.co.nz"}}'
        },

        // Maintenance & Reports
        'maintenance': {
          method: 'Get',
          typeName: 'MaintenanceReminder',
          params: '{"resultsLimit": 20}'
        },
        'exceptions': {
          method: 'Get',
          typeName: 'ExceptionEvent',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },
        'dvir': {
          method: 'Get',
          typeName: 'DVIRLog',
          params: `{"search": {"fromDate": "${lastWeek}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
        },
        'text-messages': {
          method: 'Get',
          typeName: 'TextMessage',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },

        // Advanced Multi-Calls
        'multi-odometer': {
          method: 'ExecuteMultiCall',
          typeName: '',
          params: `{"calls": [{"method": "Get", "params": {"typeName": "StatusData", "search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "deviceSearch": {"id": "b1"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 1}}, {"method": "Get", "params": {"typeName": "StatusData", "search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "deviceSearch": {"id": "b2"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 1}}]}`
        },
        'multi-status': {
          method: 'ExecuteMultiCall',
          typeName: '',
          params: '{"calls": [{"method": "Get", "params": {"typeName": "Device", "resultsLimit": 5}}, {"method": "Get", "params": {"typeName": "User", "resultsLimit": 5}}, {"method": "Get", "params": {"typeName": "Zone", "resultsLimit": 5}}]}'
        },
        'fleet-summary': {
          method: 'ExecuteMultiCall',
          typeName: '',
          params: `{"calls": [{"method": "Get", "params": {"typeName": "Device", "resultsLimit": 1000}}, {"method": "Get", "params": {"typeName": "Trip", "search": {"fromDate": "${today}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 1000}}, {"method": "Get", "params": {"typeName": "ExceptionEvent", "search": {"fromDate": "${today}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 100}}]}`
        }
      };
      
      const example = examples[type];
      if (example) {
        document.getElementById('method').value = example.method;
        document.getElementById('typeName').value = example.typeName;
        document.getElementById('params').value = example.params;
      }
    }

    // Initialize the dashboard with comprehensive API discovery
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ UCCL Dashboard loaded successfully');
      console.log('üîç Starting comprehensive MyGeotab API discovery...');
      
      // Show environment info
      const envElement = document.getElementById('environmentInfo');
      const isInMyGeotab = window.location.hostname.includes('geotab') || window !== window.parent;
      const envText = isInMyGeotab ? 'MyGeotab iframe' : 'GitHub Pages (direct)';
      envElement.textContent = envText;
      envElement.style.color = isInMyGeotab ? '#10b981' : '#f59e0b';
      
      console.log(`üåê Environment: ${envText}`);
      console.log(`üìç URL: ${window.location.href}`);
      console.log(`üñºÔ∏è Iframe: ${window !== window.parent}`);
      
      // Show loading status
      showMessage('apiResult', 'üîç Running comprehensive API discovery... (up to 30 seconds)', 'warning');
      
      // Run initial discovery to see what's available
      console.log('üìä Initial API environment scan:');
      discoverAllAPIs();
      
      try {
        // Wait for MyGeotab API to be ready
        const foundAPI = await waitForAPI();
        
        if (foundAPI && isApiReady) {
          const method = usePostMessage ? 'postMessage communication' : 'direct access';
          console.log(`üéâ MyGeotab API is ready via ${method}`);
          showMessage('apiResult', `‚úÖ Connected to MyGeotab API successfully via ${method}!`, 'success');
          updateDebugInfo();
          
          // Update status indicators
          const statusElements = document.querySelectorAll('.status-indicator');
          statusElements.forEach(el => {
            if (el) {
              el.style.background = '#10b981'; // Green
            }
          });
          
          // Clear the API result after 5 seconds
          setTimeout(() => {
            const apiResultElement = document.getElementById('apiResult');
            if (apiResultElement && apiResultElement.innerHTML.includes('Connected to MyGeotab API')) {
              apiResultElement.innerHTML = '';
            }
          }, 5000);
          
        } else {
          console.warn('‚ùå MyGeotab API not found after comprehensive search');
          updateDebugInfo();
          
          const suggestionText = isInMyGeotab 
            ? 'API may still be loading. Try refreshing the page or contact your Geotab administrator.'
            : 'You appear to be viewing this directly on GitHub Pages. For full functionality, access this through MyGeotab as a registered add-in.';
          
          showMessage('apiResult', 
            '‚ö†Ô∏è MyGeotab API not detected after comprehensive discovery (30 seconds).<br><br>' +
            `<strong>Environment:</strong> ${envText}<br>` +
            `<strong>Suggestion:</strong> ${suggestionText}<br><br>` +
            '<strong>Possible issues:</strong><br>' +
            '‚Ä¢ MyGeotab API not loaded yet in this environment<br>' +
            '‚Ä¢ API object has a different name than expected<br>' +
            '‚Ä¢ Security restrictions preventing access<br><br>' +
            '<button onclick="retryAPIConnection()" style="margin-right: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Retry Discovery</button>' +
            '<button onclick="enableTestMode()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">üß™ Test Mode</button><br>' +
            '<small>Check console for detailed discovery logs. Use debug tools for more info.</small>', 
            'warning'
          );
          
          // Update status indicators to yellow
          const statusElements = document.querySelectorAll('.status-indicator');
          statusElements.forEach(el => {
            if (el) {
              el.style.background = '#f59e0b'; // Yellow/orange
            }
          });
        }
        
      } catch (error) {
        console.error('üí• Error during API discovery:', error);
        updateDebugInfo();
        showMessage('apiResult', 
          '‚ùå Error during API discovery: ' + error.message + '<br>' +
          '<button onclick="retryAPIConnection()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Retry Discovery</button>', 
          'error'
        );
        
        // Update status indicators to red
        const statusElements = document.querySelectorAll('.status-indicator');
        statusElements.forEach(el => {
          if (el) {
            el.style.background = '#dc2626'; // Red
          }
        });
      }
    });
  </script>
</body>
</html>
