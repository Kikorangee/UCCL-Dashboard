<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RUC Distance Dashboard</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--muted:#a7b1c2;--text:#e7eefc;--accent:#4ea1ff;--warn:#ffb020;--danger:#ff5a67;--ok:#27d17f}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{padding:18px 22px;border-bottom:1px solid #1d2a44;display:flex;gap:14px;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0;font-weight:700}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#22314f;color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input{background:#0e1628;border:1px solid #23324f;color:var(--text);padding:10px;border-radius:10px}
    main{padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);border:1px solid #1d2a44;border-radius:16px;padding:14px}
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:24px;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid #2a3a5d;color:var(--muted)}
    .legend{display:flex;gap:8px;align-items:center}
    .legend span{height:10px;width:10px;display:inline-block;border-radius:2px}
    .legend .danger{background:var(--danger)}
    .legend .warn{background:var(--warn)}
    .legend .ok{background:var(--ok)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{color:var(--muted);font-weight:700;text-align:left;padding:8px}
    tbody td{padding:10px 8px;background:#0f182b;border-top:1px solid #1f2b47;border-bottom:1px solid #1f2b47}
    tbody tr{border-radius:12px}
    tbody tr td:first-child{border-left:1px solid #1f2b47;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-right:1px solid #1f2b47;border-top-right-radius:12px;border-bottom-right-radius:12px}
    .tag{padding:4px 8px;border-radius:7px;font-size:12px;font-weight:700;display:inline-block}
    .tag.danger{background:rgba(255,90,103,.12);color:#ff8c94;border:1px solid rgba(255,90,103,.3)}
    .tag.warn{background:rgba(255,176,32,.12);color:#ffd08a;border:1px solid rgba(255,176,32,.3)}
    .tag.ok{background:rgba(39,209,127,.12);color:#8cf0c1;border:1px solid rgba(39,209,127,.3)}
    .flex{display:flex;align-items:center;gap:10px}
    .grow{flex:1}
    canvas{width:100%;height:220px;background:#0e1628;border-radius:12px;border:1px solid #1d2a44}
    .foot{color:var(--muted);font-size:12px;margin-top:6px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <h1>RUC Distance Dashboard</h1>
    <div class="controls">
      <input id="csvFile" class="input" type="file" accept=".csv" />
      <button class="btn" id="btnExport" disabled>Export filtered CSV</button>
      <label class="pill"><input type="checkbox" id="toggleExcluded" checked /> Hide excluded</label>
      <label class="pill"><input type="checkbox" id="onlyAtRisk" /> Only at risk (&lt; 2000km)</label>
      <input id="search" class="input" type="search" placeholder="Search (device, plate, fleet #)" />
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card" style="grid-column: span 12;">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="legend">
            <span class="danger"></span><small>&lt; 1000 km</small>
            <span class="warn" style="margin-left:12px"></span><small>1000–2000 km</small>
            <span class="ok" style="margin-left:12px"></span><small>&gt; 2000 km</small>
          </div>
          <div class="foot" id="meta">No file loaded.</div>
        </div>
      </section>

      <section class="card" style="grid-column: span 3;">
        <div class="kpi"><div class="label">Vehicles</div><div class="value" id="kpiTotal">–</div></div>
      </section>
      <section class="card" style="grid-column: span 3;">
        <div class="kpi"><div class="label">Avg Distance Remaining</div><div class="value" id="kpiAvg">–</div></div>
      </section>
      <section class="card" style="grid-column: span 3;">
        <div class="kpi"><div class="label">&lt; 2000 km</div><div class="value" id="kpi2000">–</div></div>
      </section>
      <section class="card" style="grid-column: span 3;">
        <div class="kpi"><div class="label">&lt; 1000 km</div><div class="value" id="kpi1000">–</div></div>
      </section>

      <section class="card" style="grid-column: span 12;">
        <canvas id="chart"></canvas>
      </section>

      <section class="card" style="grid-column: span 12;">
        <table>
          <thead>
            <tr>
              <th data-key="device id" class="sortable">Device ID ▲▼</th>
              <th data-key="Fleet #" class="sortable">Fleet # ▲▼</th>
              <th data-key="REG Plate" class="sortable">REG Plate ▲▼</th>
              <th data-key="expiry" class="sortable">Expiry (km) ▲▼</th>
              <th data-key="odometer" class="sortable">Odometer (km) ▲▼</th>
              <th data-key="distance remaining" class="sortable">Distance Remaining (km) ▲▼</th>
              <th data-key="exclude" class="sortable">Excluded</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    // --- Utilities ---
    function parseNumber(x){
      if(x===null||x===undefined) return null;
      const n = String(x).replace(/[,\s]/g, "");
      if(n==="") return null;
      const v = Number(n);
      return Number.isFinite(v) ? v : null;
    }

    // CSV parser that respects quotes and commas-in-quotes
    function parseCSV(text){
      const rows=[]; let row=[]; let cur=''; let inQ=false; let i=0;
      while(i<text.length){
        const c=text[i];
        if(inQ){
          if(c==='"'){
            if(text[i+1]==='"'){ cur+='"'; i++; }
            else { inQ=false; }
          } else { cur+=c; }
        } else {
          if(c==='"') inQ=true;
          else if(c===','){ row.push(cur); cur=''; }
          else if(c==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
          else if(c==='\r'){ /* skip */ }
          else { cur+=c; }
        }
        i++;
      }
      if(cur!==''||row.length){ row.push(cur); rows.push(row); }
      // header -> objects
      const header = rows.shift()||[];
      return rows.filter(r=>r.length>0 && r.some(v=>v!=='')).map(r=>{
        const o={};
        header.forEach((h,idx)=>{ o[h.trim()] = (r[idx]??'').trim(); });
        return o;
      });
    }

    function downloadCSV(filename, rows){
      if(!rows.length) return;
      const headers = Object.keys(rows[0]);
      const esc = v => '"'+String(v).replaceAll('"','""')+'"';
      const lines = [headers.map(esc).join(',')].concat(rows.map(r=> headers.map(h=> esc(r[h]??'')).join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    // --- State ---
    let raw = [];      // raw rows from CSV
    let rows = [];     // normalized rows for display
    let sortKey = 'distance remaining';
    let sortDir = 'asc';

    // --- Rendering ---
    function normalize(data){
      return data.map(r=>{
        const expiry = parseNumber(r['expiry']);
        let odo = parseNumber(r['odometer']);
        // If odometer appears to be in metres (very large), convert to km
        if(odo !== null && odo > 1000000) odo = Math.round(odo/1000);
        let remaining = parseNumber(r['distance remaining']);
        if(remaining===null && expiry!==null && odo!==null){ remaining = Math.max(0, Math.round(expiry - odo)); }
        return {
          'device id': r['device id']||'',
          'Fleet #': r['Fleet #']||'',
          'REG Plate': r['REG Plate']||'',
          'expiry': expiry,
          'odometer': odo,
          'distance remaining': remaining,
          'exclude': r['exclude']||'',
        };
      });
    }

    function applyFilters(){
      const hideExcluded = document.getElementById('toggleExcluded').checked;
      const onlyAtRisk = document.getElementById('onlyAtRisk').checked;
      const q = document.getElementById('search').value.trim().toLowerCase();
      let filtered = rows.slice();
      if(hideExcluded){ filtered = filtered.filter(r=> !r['exclude']); }
      if(onlyAtRisk){ filtered = filtered.filter(r=> (r['distance remaining']??Infinity) < 2000); }
      if(q){
        filtered = filtered.filter(r=>
          String(r['device id']).toLowerCase().includes(q) ||
          String(r['REG Plate']).toLowerCase().includes(q) ||
          String(r['Fleet #']).toLowerCase().includes(q)
        );
      }
      filtered.sort((a,b)=>{
        const av = a[sortKey]; const bv = b[sortKey];
        if(av==null && bv!=null) return 1;
        if(av!=null && bv==null) return -1;
        if(av==null && bv==null) return 0;
        if(typeof av === 'number' && typeof bv === 'number') return sortDir==='asc'? av-bv : bv-av;
        return sortDir==='asc'? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
      });
      renderTable(filtered);
      renderKpis(filtered);
      renderChart(filtered);
      document.getElementById('btnExport').disabled = filtered.length===0;
      document.getElementById('btnExport').onclick = ()=> downloadCSV('ruc_dashboard_filtered.csv', filtered.map(r=>({
        'device id': r['device id'],
        'Fleet #': r['Fleet #'],
        'REG Plate': r['REG Plate'],
        'expiry': r['expiry'],
        'odometer': r['odometer'],
        'distance remaining': r['distance remaining'],
        'exclude': r['exclude'],
      })));
    }

    function renderKpis(data){
      const total = data.length;
      const rem = data.map(r=>r['distance remaining']).filter(v=>v!=null);
      const avg = rem.length? Math.round(rem.reduce((a,b)=>a+b,0)/rem.length) : null;
      const lt2000 = data.filter(r=> (r['distance remaining']??Infinity) < 2000).length;
      const lt1000 = data.filter(r=> (r['distance remaining']??Infinity) < 1000).length;
      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiAvg').textContent = avg==null? '–' : avg.toLocaleString();
      document.getElementById('kpi2000').textContent = lt2000;
      document.getElementById('kpi1000').textContent = lt1000;
    }

    function renderTable(data){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      for(const r of data){
        const tr = document.createElement('tr');
        const status = r['distance remaining']==null ? 'warn' : r['distance remaining']<1000 ? 'danger' : r['distance remaining']<2000 ? 'warn' : 'ok';
        tr.innerHTML = `
          <td>${r['device id']||''}</td>
          <td>${r['Fleet #']||''}</td>
          <td>${r['REG Plate']||''}</td>
          <td>${r['expiry']!=null? r['expiry'].toLocaleString():''}</td>
          <td>${r['odometer']!=null? r['odometer'].toLocaleString():''}</td>
          <td><span class="tag ${status}">${r['distance remaining']!=null? r['distance remaining'].toLocaleString(): 'n/a'}</span></td>
          <td>${r['exclude']? 'Yes':''}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function renderChart(data){
      const ctx = document.getElementById('chart').getContext('2d');
      const buckets = [0,500,1000,1500,2000,3000,5000,10000,Infinity];
      const labels = ['<500','500–999','1k–1.5k','1.5k–2k','2k–3k','3k–5k','5k–10k','>10k'];
      const counts = new Array(labels.length).fill(0);
      for(const r of data){
        const v = r['distance remaining'];
        if(v==null) continue;
        let idx = 0;
        for(let i=0;i<buckets.length-1;i++){
          if(v>=buckets[i] && v<buckets[i+1]){ idx = i; break; }
        }
        counts[idx]++;
      }
      // Simple bar chart without external libs
      const W = ctx.canvas.width, H = ctx.canvas.height;
      ctx.clearRect(0,0,W,H);
      const max = Math.max(1, ...counts);
      const barW = Math.floor((W - 40) / counts.length) - 8; // padding
      ctx.font = '12px system-ui';
      ctx.fillStyle = '#a7b1c2';
      ctx.textAlign = 'center';
      // axes
      ctx.strokeStyle = '#23324f';
      ctx.beginPath(); ctx.moveTo(30,10); ctx.lineTo(30,H-30); ctx.lineTo(W-10,H-30); ctx.stroke();
      for(let i=0;i<counts.length;i++){
        const x = 40 + i*(barW+8);
        const h = Math.round(((H-60) * counts[i]) / max);
        const y = (H-30) - h;
        // color by risk-ish
        let fill = '#27d17f';
        if(i<=2) fill = '#ff5a67';
        else if(i<=3) fill = '#ffb020';
        ctx.fillStyle = fill;
        ctx.fillRect(x, y, barW, h);
        ctx.fillStyle = '#a7b1c2';
        ctx.fillText(labels[i], x+barW/2, H-12);
        ctx.fillText(String(counts[i]), x+barW/2, y-4);
      }
    }

    // --- Events ---
    document.getElementById('csvFile').addEventListener('change', e=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        raw = parseCSV(String(ev.target.result||''));
        rows = normalize(raw);
        document.getElementById('meta').textContent = `${file.name} • ${rows.length} rows`;
        applyFilters();
      };
      reader.readAsText(file);
    });

    document.getElementById('toggleExcluded').addEventListener('change', applyFilters);
    document.getElementById('onlyAtRisk').addEventListener('change', applyFilters);
    document.getElementById('search').addEventListener('input', ()=>{
      // simple debounce
      clearTimeout(window.__deb); window.__deb = setTimeout(applyFilters, 180);
    });

    document.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.getAttribute('data-key');
        if(sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); }
        else { sortKey = key; sortDir = 'asc'; }
        applyFilters();
      });
    });
  </script>
</body>
</html>
