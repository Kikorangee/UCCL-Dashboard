<script>
window.addEventListener('load', function () {
  if (!window.api) {
    alert("Geotab API not foundâ€”ensure this is running as an Add-In in MyGeotab");
    return;
  }

  window.api.call("Get", { typeName: "Device" }, function (devices) {
    fetch("https://kikorangee.github.io/UCCL-Dashboard/RUC.csv")
      .then(res => res.ok ? res.text() : Promise.reject("CSV fetch failed"))
      .then(text => {
        const [headerLine, ...rows] = text.trim().split("\n");
        const headers = headerLine.split(",");
        const rucData = rows.map(row => {
          const cols = row.split(",");
          return headers.reduce((obj, h, i) => (obj[h.trim()] = cols[i].trim(), obj), {});
        });

        // Build table
        const table = document.createElement("table");
        table.innerHTML = "<tr><th>Fleet #</th><th>Vehicle</th><th>Odo (km)</th><th>Expiry (km)</th><th>Remaining</th></tr>";
        document.body.appendChild(table);

        devices.forEach(device => {
          const entry = rucData.find(e => e["Fleet #"] === device.name);
          if (!entry) return;

          window.api.call("Get", {
            typeName: "StatusData",
            search: {
              diagnosticSearch: { id: "DiagnosticOdometerAdjustmentId" },
              deviceSearch: { id: device.id },
              fromDate: new Date().toISOString(),
              toDate: new Date().toISOString()
            }
          }, data => {
            const odo = data[0]?.data || 0;
            const expiry = parseFloat(entry["RUC Expiry (km)"] || 0);
            const remaining = (expiry - odo).toFixed(0);

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${entry["Fleet #"]}</td>
              <td>${device.vehicleIdentificationNumber || device.name}</td>
              <td>${odo}</td>
              <td>${expiry}</td>
              <td>${remaining}</td>
            `;
            table.appendChild(row);
          });
        });
      })
      .catch(err => console.error("Error loading RUC data:", err));
  });
});
</script>
