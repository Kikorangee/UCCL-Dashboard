<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Northland Geofence Monitoring System</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;color:#333;padding:20px;font-size:16px}
    .container{max-width:1600px;margin:0 auto}
    .header,.card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:30px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header{text-align:center}
    .header h1{color:#2d3748;font-size:2.5em;font-weight:700;margin-bottom:15px}
    .header p{font-size:1.1em;color:#666}
    .card-title{color:#2d3748;font-size:1.5em;font-weight:700;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e2e8f0}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:20px}
    .form-control{width:100%;padding:14px 18px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:all .2s ease}
    .form-control:focus{outline:none;border-color:#1e3c72;box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .btn{padding:14px 28px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s ease;margin:5px}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .btn-primary{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff}
    .btn-success{background:linear-gradient(135deg,#48bb78,#38a169);color:#fff}
    .btn-warning{background:linear-gradient(135deg,#ed8936,#dd6b20);color:#fff}
    .btn-danger{background:linear-gradient(135deg,#f56565,#e53e3e);color:#fff}
    .btn-info{background:linear-gradient(135deg,#4299e1,#3182ce);color:#fff}
    .btn-secondary{background:linear-gradient(135deg,#718096,#4a5568);color:#fff}
    .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}
    .btn-sm{padding:8px 16px;font-size:14px}
    .alert{padding:18px;border-radius:8px;margin:18px 0;font-weight:500;font-size:16px}
    .alert-success{background:#c6f6d5;color:#22543d;border-left:4px solid #38a169}
    .alert-error{background:#fed7d7;color:#742a2a;border-left:4px solid #e53e3e}
    .alert-warning{background:#fefcbf;color:#744210;border-left:4px solid #d69e2e}
    .alert-info{background:#ebf8ff;color:#2b6cb0;border-left:4px solid #4299e1}
    .geofence-table{width:100%;border-collapse:collapse;margin-top:25px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .geofence-table th{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:16px;text-align:left;font-weight:600;font-size:16px}
    .geofence-table td{padding:14px 16px;border-bottom:1px solid #e2e8f0;font-size:15px;vertical-align:top;line-height:1.4}
    .geofence-table tr:hover{background:#f7fafc}
    .geofence-table tr:nth-child(even){background:#f8f9fa}
    .status-inside{background:#c6f6d5;color:#22543d;padding:6px 12px;border-radius:6px;font-weight:600;font-size:14px}
    .status-outside{background:#fed7d7;color:#742a2a;padding:6px 12px;border-radius:6px;font-weight:600;font-size:14px}
    .muted{color:#718096;font-size:14px}
    .config-section{background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0}
    .config-section h4{margin-bottom:15px;color:#2d3748}
    .checkbox-group{margin:10px 0}
    .checkbox-group label{display:flex;align-items:center;gap:8px;cursor:pointer}
    .checkbox-group input[type="checkbox"]{width:18px;height:18px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
    .stat-card{background:white;padding:20px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.1);border-top:4px solid #1e3c72}
    .stat-number{font-size:2em;font-weight:700;color:#1e3c72;margin:5px 0}
    .stat-label{color:#666;font-size:0.9em}
    .map-container{height:600px;background:#f8f9fa;border-radius:10px;margin:20px 0;border:2px solid #e2e8f0;position:relative;overflow:hidden;z-index:1}
    #map{height:100%;width:100%}
    .geofence-manager{background:#fff;padding:20px;border-radius:8px;margin:20px 0;border:2px solid #e2e8f0}
    .geofence-item{background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid #1e3c72;display:flex;justify-content:space-between;align-items:center}
    .geofence-item.active{border-left-color:#48bb78;background:#c6f6d5}
    .geofence-actions{display:flex;gap:8px}
    .alert-panel{position:fixed;top:50%;right:20px;transform:translateY(-50%);background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:15px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);z-index:1000;min-width:300px;max-width:400px;border:2px solid #e53e3e;max-height:80vh;overflow-y:auto}
    .alert-panel h4{color:#e53e3e;margin-bottom:15px;text-align:center;border-bottom:2px solid #e2e8f0;padding-bottom:10px}
    .violation-item{background:#fff;padding:12px;margin:8px 0;border-radius:6px;border-left:4px solid #e53e3e;font-size:14px}
    .alert-buttons{display:flex;flex-direction:column;gap:10px;margin-top:15px}
    .alert-btn{padding:10px 16px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s ease}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .modal-title{font-size:1.5em;margin-bottom:20px;color:#2d3748}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    textarea{width:100%;min-height:100px;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-family:monospace;font-size:14px;resize:vertical}
    
    /* Vehicle policy styles */
    .policy-section{background:#fff;padding:20px;border-radius:8px;margin:20px 0;border:2px solid #e2e8f0}
    .vehicle-group{background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid #4299e1}
    .vehicle-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin-top:10px}
    .vehicle-badge{background:#4299e1;color:white;padding:4px 8px;border-radius:4px;font-size:12px;text-align:center;font-weight:600}
    
    /* Fix for Leaflet icons in Geotab */
    .leaflet-container {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üö® Northland Geofence Monitoring System</h1>
      <p>Complete vehicle policy enforcement with real-time boundary monitoring</p>
    </div>

    <div class="card">
      <h3 class="card-title">Authentication</h3>
      <div class="form-row">
        <input id="server" class="form-control" placeholder="Server" value="my.geotab.com" />
        <input id="database" class="form-control" placeholder="Database" value="uccnz" />
      </div>
      <div class="form-row">
        <input id="username" class="form-control" placeholder="Username" value="francis@directt.co.nz" />
        <input id="password" class="form-control" type="password" placeholder="Password" value="@fr4nc1sWynn5" />
      </div>
      <button id="authButton" class="btn btn-primary">üîê Authenticate</button>
      <div id="authResult"></div>
    </div>

    <div id="monitoringSection" class="card" style="display:none;">
      <h3 class="card-title">üöó Vehicle Policy Enforcement</h3>
      
      <!-- Vehicle Policy Groups -->
      <div class="policy-section">
        <h4>Vehicle Permission Groups</h4>
        
        <div class="vehicle-group">
          <strong>Group 1 - Full Use (No Restrictions)</strong>
          <div class="vehicle-list">
            <span class="vehicle-badge">520</span><span class="vehicle-badge">529</span>
            <span class="vehicle-badge">541</span><span class="vehicle-badge">543</span>
            <span class="vehicle-badge">544</span><span class="vehicle-badge">546</span>
          </div>
          <p class="muted">Full vehicle access - North Island or NZ wide</p>
        </div>
        
        <div class="vehicle-group">
          <strong>Group 2 - Northland Region Only</strong>
          <div class="vehicle-list">
            <span class="vehicle-badge">490</span><span class="vehicle-badge">517</span>
            <span class="vehicle-badge">518</span><span class="vehicle-badge">519</span>
            <span class="vehicle-badge">530</span><span class="vehicle-badge">534</span>
            <span class="vehicle-badge">535</span><span class="vehicle-badge">542</span>
            <span class="vehicle-badge">552</span><span class="vehicle-badge">553</span>
          </div>
          <p class="muted">Restricted to Northland Region boundaries</p>
        </div>
        
        <div class="vehicle-group">
          <strong>Group 3 - Whangarei District + 30km Radius</strong>
          <div class="vehicle-list">
            <span class="vehicle-badge">471</span><span class="vehicle-badge">502</span>
            <span class="vehicle-badge">508</span><span class="vehicle-badge">510</span>
            <span class="vehicle-badge">513</span><span class="vehicle-badge">515</span>
            <span class="vehicle-badge">522</span><span class="vehicle-badge">526</span>
            <span class="vehicle-badge">527</span><span class="vehicle-badge">533</span>
            <span class="vehicle-badge">537</span><span class="vehicle-badge">538</span>
            <span class="vehicle-badge">539</span><span class="vehicle-badge">540</span>
            <span class="vehicle-badge">545</span><span class="vehicle-badge">549</span>
            <span class="vehicle-badge">550</span><span class="vehicle-badge">516</span>
          </div>
          <p class="muted">Whangarei District or 30km from residence</p>
        </div>
        
        <div class="vehicle-group">
          <strong>Group 4 - Hawkes Bay Region</strong>
          <div class="vehicle-list">
            <span class="vehicle-badge">536</span>
          </div>
          <p class="muted">Tony Abiad - Hawkes Bay Region only</p>
        </div>
        
        <div class="vehicle-group">
          <strong>Group 5 - Napier District + 30km Radius</strong>
          <div class="vehicle-list">
            <span class="vehicle-badge">521</span><span class="vehicle-badge">523</span>
            <span class="vehicle-badge">551</span>
          </div>
          <p class="muted">Napier District or 30km from residence</p>
        </div>
        
        <div class="vehicle-group">
          <strong>Group 6 - Time-Restricted Trade Staff</strong>
          <div class="vehicle-list">
            <span class="vehicle-badge">465</span><span class="vehicle-badge">470</span>
            <span class="vehicle-badge">476</span><span class="vehicle-badge">487</span>
            <span class="vehicle-badge">488</span><span class="vehicle-badge">489</span>
            <span class="vehicle-badge">491</span><span class="vehicle-badge">492</span>
            <span class="vehicle-badge">493</span><span class="vehicle-badge">494</span>
            <span class="vehicle-badge">495</span><span class="vehicle-badge">496</span>
            <span class="vehicle-badge">500</span><span class="vehicle-badge">501</span>
            <span class="vehicle-badge">503</span><span class="vehicle-badge">505</span>
            <span class="vehicle-badge">511</span><span class="vehicle-badge">512</span>
            <span class="vehicle-badge">514</span><span class="vehicle-badge">524</span>
            <span class="vehicle-badge">525</span><span class="vehicle-badge">528</span>
            <span class="vehicle-badge">531</span><span class="vehicle-badge">532</span>
          </div>
          <p class="muted">After 6pm & before 4am Weekdays + All Weekend</p>
        </div>
      </div>

      <h3 class="card-title">üó∫Ô∏è Geofence Manager</h3>
      
      <div class="geofence-manager">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h4>üìç Policy Geofences</h4>
          <div>
            <button id="createGeofence" class="btn btn-success btn-sm">‚ûï Create New Geofence</button>
            <button id="importGeofence" class="btn btn-info btn-sm">üì• Import</button>
            <button id="loadPolicyGeofences" class="btn btn-primary btn-sm">üöó Load Policy Geofences</button>
          </div>
        </div>
        
        <div id="geofenceList"></div>
      </div>

      <div class="config-section">
        <h4>‚öôÔ∏è Monitoring Configuration</h4>
        
        <div class="alert alert-info" style="font-size:14px;padding:12px;margin-bottom:15px;">
          <strong>üí° Policy Enforcement Active:</strong> Time-based restrictions and boundary monitoring enabled for all vehicle groups.
        </div>
        
        <div class="form-row">
          <div>
            <label for="activeGeofence">Active Geofence:</label>
            <select id="activeGeofence" class="form-control">
              <option value="">Select geofence to monitor...</option>
            </select>
          </div>
          <div>
            <label for="defaultTimeout">Timeout (minutes):</label>
            <input id="defaultTimeout" class="form-control" type="number" value="30" min="1" />
          </div>
          <div>
            <label for="checkInterval">Check Interval (seconds):</label>
            <input id="checkInterval" class="form-control" type="number" value="30" min="5" />
          </div>
          <div>
            <label for="resultsLimit">Assets Limit:</label>
            <input id="resultsLimit" class="form-control" type="number" value="50" min="1" max="1000" />
          </div>
        </div>
        
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="enableRealTime" checked />
            Enable Real-time Monitoring
          </label>
        </div>
        
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="enableAlerts" checked />
            Enable Audio Alerts for Violations
          </label>
        </div>
        
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="enableTimeRestrictions" checked />
            Enforce Time-Based Restrictions
          </label>
        </div>
      </div>
      
      <div id="infoBanner" class="alert alert-info" style="display:none;"></div>
      
      <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
        <button id="startMonitoring" class="btn btn-success">üöÄ Start Policy Monitoring</button>
        <button id="stopMonitoring" class="btn btn-danger" disabled>‚èπÔ∏è Stop Monitoring</button>
        <button id="checkViolations" class="btn btn-warning">üîç Check Policy Compliance</button>
        <button id="showMap" class="btn btn-primary">üó∫Ô∏è Show Policy Map</button>
        <button id="logout" class="btn btn-danger">üö™ Logout</button>
      </div>
      
      <div id="monitoringStats" style="display:none;">
        <h4>üìä Policy Compliance Statistics</h4>
        <div class="stats-grid">
          <div class="stat-card">
            <div id="totalMonitored" class="stat-number">0</div>
            <div class="stat-label">Total Monitored</div>
          </div>
          <div class="stat-card">
            <div id="insideBoundary" class="stat-number">0</div>
            <div class="stat-label">Inside Boundary</div>
          </div>
          <div class="stat-card">
            <div id="outsideBoundary" class="stat-number">0</div>
            <div class="stat-label">Outside Boundary</div>
          </div>
          <div class="stat-card">
            <div id="violations" class="stat-number">0</div>
            <div class="stat-label">Policy Violations</div>
          </div>
        </div>
      </div>

      <div class="map-container" id="mapContainer" style="display:none;">
        <div id="map"></div>
      </div>
      
      <div id="monitoringResult"></div>
    </div>
  </div>

  <div id="alertPanel" class="alert-panel" style="display:none;">
    <h4>üö® Policy Violations</h4>
    <div id="activeAlerts"></div>
    <div class="alert-buttons">
      <button id="acknowledgeAll" class="alert-btn" style="background:#48bb78;color:white;">‚úÖ Acknowledge All</button>
      <button id="closeAlerts" class="alert-btn" style="background:#718096;color:white;">‚úñÔ∏è Close Panel</button>
    </div>
  </div>

  <!-- Create/Edit Geofence Modal -->
  <div id="geofenceModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">Create New Geofence</h3>
      
      <div class="alert alert-info" style="font-size:14px;padding:12px;margin-bottom:20px;">
        <strong>Step 1:</strong> Enter a name for your geofence<br>
        <strong>Step 2:</strong> Choose how to define the boundary<br>
        <strong>Step 3:</strong> Save your geofence
      </div>
      
      <div style="margin-bottom:20px;">
        <label for="geofenceName">Geofence Name: *</label>
        <input id="geofenceName" class="form-control" placeholder="e.g., Northland Region, Auckland Area" />
      </div>
      <div style="margin-bottom:20px;">
        <label for="geofenceColor">Display Color:</label>
        <input id="geofenceColor" class="form-control" type="color" value="#1e3c72" />
      </div>
      <div style="margin-bottom:20px;">
        <p style="font-weight:600;margin-bottom:10px;">Define Boundary:</p>
        <div class="two-col" style="margin-top:10px;">
          <button id="drawOnMap" class="btn btn-primary">üñäÔ∏è Draw on Map</button>
          <button id="enterCoordinates" class="btn btn-info">üìç Enter Coordinates</button>
        </div>
      </div>
      <div id="coordinateInput" style="display:none;margin-bottom:20px;">
        <label>Coordinates (lat,lng per line):</label>
        <textarea id="coordTextarea" placeholder="-35.0, 173.0&#10;-35.0, 174.5&#10;-36.5, 174.5&#10;-36.5, 173.0"></textarea>
        <p class="muted" style="margin-top:8px;">Enter at least 3 points to create a polygon</p>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="cancelGeofence" class="btn btn-secondary">Cancel</button>
        <button id="saveGeofence" class="btn btn-success" disabled>üíæ Save Geofence</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Import Geofence</h3>
      <div style="margin-bottom:20px;">
        <label>Paste Geofence JSON:</label>
        <textarea id="importTextarea" placeholder='{"name":"My Geofence","coordinates":[...]}'></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="cancelImport" class="btn btn-secondary">Cancel</button>
        <button id="confirmImport" class="btn btn-success">Import</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
    let credentials = null;
    let serverUsed = null;
    let monitoringInterval = null;
    let isMonitoring = false;
    let activeViolations = new Map();
    let map = null;
    let markers = new Map();
    let geofences = [];
    let geofencePolygons = new Map();
    let drawControl = null;
    let drawnItems = null;
    let tempGeofenceCoords = null;
    let isDrawingMode = false;
    let deviceToVehicleMap = new Map(); // Cache for device ID to vehicle number mapping

    // Vehicle Policy Groups
    const VEHICLE_GROUPS = {
      fullUse: ['520', '529', '541', '543', '544', '546'],
      northlandRegion: ['490', '517', '518', '519', '530', '534', '535', '542', '552', '553'],
      whangareiDistrict: ['471', '502', '508', '510', '513', '515', '522', '526', '527', '533', '537', '538', '539', '540', '545', '549', '550', '516'],
      hawkesBay: ['536'],
      napierDistrict: ['521', '523', '551'],
      timeRestricted: ['465', '470', '476', '487', '488', '489', '491', '492', '493', '494', '495', '496', '500', '501', '503', '505', '511', '512', '514', '524', '525', '528', '531', '532']
    };

    // Policy Geofences
    const POLICY_GEOFENCES = [
      {
        id: 'northland-region',
        name: 'Northland Region',
        coordinates: [
          [-34.4, 172.8],
          [-34.4, 174.8],
          [-36.5, 174.8],
          [-36.5, 172.8],
          [-34.4, 172.8]
        ],
        color: '#1e3c72',
        active: true
      },
      {
        id: 'whangarei-district',
        name: 'Whangarei District',
        coordinates: [
          [-35.525, 174.255],
          [-35.525, 174.355],
          [-35.625, 174.355],
          [-35.625, 174.255],
          [-35.525, 174.255]
        ],
        color: '#48bb78',
        active: false
      },
      {
        id: 'hawkes-bay-region',
        name: 'Hawkes Bay Region',
        coordinates: [
          [-39.0, 176.3],
          [-39.0, 177.8],
          [-40.2, 177.8],
          [-40.2, 176.3],
          [-39.0, 176.3]
        ],
        color: '#ed8936',
        active: false
      },
      {
        id: 'napier-district',
        name: 'Napier District',
        coordinates: [
          [-39.48, 176.85],
          [-39.48, 176.95],
          [-39.52, 176.95],
          [-39.52, 176.85],
          [-39.48, 176.85]
        ],
        color: '#9f7aea',
        active: false
      },
      {
        id: 'far-north-boundary',
        name: 'Far North Boundary Line',
        coordinates: [
          [-35.233, 173.917],
          [-35.533, 173.667],
          [-35.917, 173.783]
        ],
        color: '#e53e3e',
        active: false
      }
    ];

    // Enhanced environment detection
    let isGeotabEnvironment = false;

    function detectEnvironment() {
      console.log('=== Environment Detection ===');
      const geotabDetected = window.parent !== window;
      const leafletAvailable = typeof L !== 'undefined';
      console.log('Geotab Add-In:', geotabDetected);
      console.log('Leaflet Available:', leafletAvailable);
      console.log('User Agent:', navigator.userAgent);

      isGeotabEnvironment = geotabDetected;

      if (isGeotabEnvironment && !leafletAvailable) {
        console.warn('‚ö†Ô∏è Geotab environment detected with CDN-blocked resources');
        console.log('üí° Using fallback map mode (Google Maps links)');
      }

      return {
        isGeotab: geotabDetected,
        leafletAvailable: leafletAvailable
      };
    }

    function initializeGeofences() {
      geofences = [...POLICY_GEOFENCES];
      renderGeofenceList();
      updateActiveGeofenceSelect();
    }

    function loadPolicyGeofences() {
      geofences = [...POLICY_GEOFENCES];
      renderGeofenceList();
      updateActiveGeofenceSelect();
      
      if (map) {
        drawAllGeofences();
      }
      
      showMessage('infoBanner', '‚úÖ All policy geofences loaded successfully!', 'success');
    }

    function showMessage(elId, msg, type='info'){
      const el = document.getElementById(elId);
      const c = type==='error'?'alert-error':type==='success'?'alert-success':type==='warning'?'alert-warning':'alert-info';
      el.style.display = '';
      el.innerHTML = `<div class="alert ${c}">${msg}</div>`;
    }

    async function callGeotabAPI(method, params={}){
      const requestBody = { method, params: credentials ? {...params, credentials} : params };
      const res = await fetch(`https://${serverUsed}/apiv1`, {
        method:'POST', 
        headers:{'Content-Type':'application/json','Accept':'application/json'}, 
        body: JSON.stringify(requestBody)
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      const data = await res.json();
      if(data.error) throw new Error(data.error.message || data.error.name);
      return data.result;
    }

    // TIME-BASED RESTRICTION CHECK
    function checkTimeRestrictions(vehicleNumber) {
      if (!document.getElementById('enableTimeRestrictions').checked) {
        return true; // Time restrictions disabled
      }
      
      const tradeStaffVehicles = VEHICLE_GROUPS.timeRestricted;
      const nickAshurstVehicle = '522';
      
      if (!tradeStaffVehicles.includes(vehicleNumber) && vehicleNumber !== nickAshurstVehicle) {
        return true; // No time restrictions
      }
      
      const now = new Date();
      const day = now.getDay(); // 0=Sunday, 6=Saturday
      const hour = now.getHours();
      
      // Weekend - all hours permitted for everyone
      if (day === 0 || day === 6) return true;
      
      // Weekday time restrictions
      if (tradeStaffVehicles.includes(vehicleNumber)) {
        return hour >= 18 || hour < 4; // After 6pm OR before 4am
      }
      
      // Nick Ashurst specific (same as trade staff)
      if (vehicleNumber === nickAshurstVehicle) {
        return hour >= 18 || hour < 4;
      }
      
      return true;
    }

    function getVehicleGroup(vehicleNumber) {
      for (const [group, vehicles] of Object.entries(VEHICLE_GROUPS)) {
        if (vehicles.includes(vehicleNumber)) {
          return group;
        }
      }
      return 'unknown';
    }

    async function getVehicleNumberFromDevice(deviceId) {
      // Check cache first
      if (deviceToVehicleMap.has(deviceId)) {
        return deviceToVehicleMap.get(deviceId);
      }

      try {
        // Fetch device details to get the vehicle number
        const devices = await callGeotabAPI('Get', {
          typeName: 'Device',
          search: { id: deviceId }
        });

        if (devices && devices.length > 0) {
          const device = devices[0];
          // Try to extract vehicle number from device name or serial number
          let vehicleNumber = 'unknown';

          // Try to match device name to vehicle number
          if (device.name) {
            // Extract number from device name (e.g., "Vehicle 520" -> "520")
            const match = device.name.match(/\d+/);
            if (match) {
              vehicleNumber = match[0];
            } else if (device.serialNumber) {
              // Fallback to serial number if available
              const serialMatch = device.serialNumber.match(/\d+/);
              if (serialMatch) {
                vehicleNumber = serialMatch[0];
              }
            }
          }

          // Cache the mapping
          deviceToVehicleMap.set(deviceId, vehicleNumber);
          console.log(`Device ${deviceId} mapped to vehicle ${vehicleNumber}`);
          return vehicleNumber;
        }
      } catch (error) {
        console.warn(`Could not fetch device details for ${deviceId}:`, error);
      }

      return 'unknown';
    }

    function isInGeofence(lat, lon, geofence) {
      if (!lat || !lon || !geofence) return false;
      
      const point = [lat, lon];
      const polygon = geofence.coordinates;
      
      let inside = false;
      for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const xi = polygon[i][1], yi = polygon[i][0];
        const xj = polygon[j][1], yj = polygon[j][0];
        
        const intersect = ((yi > lon) !== (yj > lon))
            && (lat < (xj - xi) * (lon - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      
      return inside;
    }

    function getActiveGeofence() {
      const activeId = document.getElementById('activeGeofence').value;
      return geofences.find(g => g.id === activeId);
    }

    function renderGeofenceList() {
      const container = document.getElementById('geofenceList');
      
      if (geofences.length === 0) {
        container.innerHTML = '<p class="muted">No geofences created. Click "Load Policy Geofences" to get started.</p>';
        return;
      }

      let html = '';
      geofences.forEach(geofence => {
        const isActive = geofence.id === document.getElementById('activeGeofence').value;
        html += `
          <div class="geofence-item ${isActive ? 'active' : ''}">
            <div>
              <strong>${geofence.name}</strong>
              <p class="muted">${geofence.coordinates.length} points ‚Ä¢ ${isActive ? '‚úÖ Active' : ''}</p>
            </div>
            <div class="geofence-actions">
              <button onclick="viewGeofence('${geofence.id}')" class="btn btn-info btn-sm">üëÅÔ∏è View</button>
              <button onclick="exportGeofence('${geofence.id}')" class="btn btn-warning btn-sm">üì§ Export</button>
              <button onclick="deleteGeofence('${geofence.id}')" class="btn btn-danger btn-sm">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function updateActiveGeofenceSelect() {
      const select = document.getElementById('activeGeofence');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">Select geofence to monitor...</option>';
      
      geofences.forEach(geofence => {
        const option = document.createElement('option');
        option.value = geofence.id;
        option.textContent = geofence.name;
        select.appendChild(option);
      });
      
      if (currentValue && geofences.find(g => g.id === currentValue)) {
        select.value = currentValue;
      } else if (geofences.length > 0) {
        select.value = geofences[0].id;
      }
    }

    async function getCurrentLocations() {
      try {
        const resultsLimit = parseInt(document.getElementById('resultsLimit').value) || 50;
        
        const devices = await callGeotabAPI('Get', {
          typeName: 'Device',
          resultsLimit: resultsLimit
        });
        
        console.log('Found devices:', devices.length);
        
        const locations = [];
        
        for (const device of devices) {
          try {
            const statusData = await callGeotabAPI('Get', {
              typeName: 'DeviceStatusInfo',
              search: {
                deviceSearch: { id: device.id }
              }
            });
            
            if (statusData && statusData.length > 0) {
              const status = statusData[0];
              if (status.latitude && status.longitude) {
                locations.push({
                  deviceId: device.id,
                  deviceName: device.name,
                  latitude: status.latitude,
                  longitude: status.longitude,
                  speed: status.speed || 0,
                  timestamp: new Date(status.dateTime || Date.now())
                });
              }
            }
          } catch (error) {
            console.warn(`Could not get location for device ${device.name}:`, error);
          }
        }
        
        console.log('Found locations:', locations.length);
        return locations;
        
      } catch (error) {
        console.error('Error getting locations:', error);
        throw error;
      }
    }

    function initializeMap() {
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.style.display = 'block';

      // In Geotab environments, skip Leaflet entirely and use fallback mode
      if (isGeotabEnvironment) {
        console.log('üîß Geotab environment detected - using fallback map mode');
        showFallbackMap();
        return null;
      }

      // Check if Leaflet is available
      if (typeof L === 'undefined') {
        console.warn('Leaflet not available - using fallback map view');
        console.log('Leaflet availability check failed, switching to fallback');
        showFallbackMap();
        return null;
      }

      try {
        if (map) {
          map.remove();
        }

        // Initialize map with better error handling
        const mapElement = document.getElementById('map');
        if (!mapElement) {
          console.error('Map element not found');
          return null;
        }

        console.log('Creating Leaflet map instance...');
        map = L.map('map').setView([-35.5, 173.8], 8);
        console.log('Leaflet map created successfully');

        // Add tile layer with error handling
        try {
          console.log('Adding tile layer...');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
          }).addTo(map);
          console.log('Tile layer added successfully');
        } catch (tileError) {
          console.warn('Tile layer failed, using fallback:', tileError);
          showFallbackMap();
          return null;
        }

        // Initialize draw control
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Draw all geofences
        drawAllGeofences();

        console.log('Map initialized successfully');
        return map;
      } catch (error) {
        console.error('Map initialization failed:', error);
        console.error('Error details:', error.message, error.stack);
        showFallbackMap();
        return null;
      }
    }

    function showFallbackMap() {
      const mapContainer = document.getElementById('mapContainer');
      const mapDiv = document.getElementById('map');

      console.log('Initializing fallback map display');

      // Make sure container is visible
      mapContainer.style.display = 'block';

      mapDiv.innerHTML = `
        <div style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:30px;background:#f8f9fa;overflow-y:auto;">
          <h3 style="color:#2d3748;margin-bottom:20px;">üìç Policy Geofences & Vehicle Locations</h3>
          <p style="color:#718096;text-align:center;margin-bottom:20px;">
            Interactive maps are not available in Geotab Add-In mode.<br>
            Click links below to view on Google Maps.
          </p>
          <div id="fallbackMapContent" style="width:100%;max-width:900px;"></div>
        </div>
      `;

      console.log('Fallback map container displayed');

      // Show geofences and any existing data
      updateFallbackMap();
    }

    function updateFallbackMap() {
      const content = document.getElementById('fallbackMapContent');
      if (!content) return;

      let html = '<div style="text-align:left;width:100%;">';
      
      // Show geofences
      if (geofences.length > 0) {
        html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">';
        html += '<h4 style="margin-bottom:15px;color:#1e3c72;">üìç Policy Geofences:</h4>';
        geofences.forEach(geofence => {
          const center = calculateCenter(geofence.coordinates);
          const mapLink = `https://www.google.com/maps?q=${center[0]},${center[1]}&z=10`;
          const isActive = geofence.id === document.getElementById('activeGeofence').value;
          
          html += `
            <div style="background:${isActive ? '#c6f6d5' : '#f8f9fa'};padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid ${geofence.color};">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                <div>
                  <strong style="font-size:16px;">${geofence.name}</strong> ${isActive ? '<span style="color:#38a169;font-weight:600;">‚úì Active</span>' : ''}<br>
                  <span style="color:#718096;font-size:14px;">${geofence.coordinates.length} boundary points</span>
                </div>
                <a href="${mapLink}" target="_blank" class="btn btn-info btn-sm" style="text-decoration:none;white-space:nowrap;">üó∫Ô∏è View on Google Maps</a>
              </div>
            </div>
          `;
        });
        html += '</div>';
      } else {
        html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;text-align:center;">';
        html += '<p style="color:#718096;">No policy geofences loaded yet. Click "Load Policy Geofences" to get started!</p>';
        html += '</div>';
      }
      
      html += '</div>';
      content.innerHTML = html;
    }

    function calculateCenter(coordinates) {
      let lat = 0, lng = 0;
      coordinates.forEach(coord => {
        lat += coord[0];
        lng += coord[1];
      });
      return [lat / coordinates.length, lng / coordinates.length];
    }

    function drawAllGeofences() {
      if (!map || typeof L === 'undefined') {
        updateFallbackMap();
        return;
      }

      try {
        // Clear existing geofence polygons
        geofencePolygons.forEach(polygon => map.removeLayer(polygon));
        geofencePolygons.clear();

        // Draw each geofence
        geofences.forEach(geofence => {
          const polygon = L.polygon(geofence.coordinates, {
            color: geofence.color,
            fillColor: geofence.color,
            fillOpacity: 0.1,
            weight: 3
          }).addTo(map);

          polygon.bindPopup(`<b>${geofence.name}</b><br>${geofence.coordinates.length} points<br>Policy Boundary`);
          geofencePolygons.set(geofence.id, polygon);
        });

        // Fit map to show all geofences
        if (geofences.length > 0) {
          const allBounds = L.latLngBounds([]);
          geofences.forEach(geofence => {
            geofence.coordinates.forEach(coord => {
              allBounds.extend(coord);
            });
          });
          map.fitBounds(allBounds, { padding: [50, 50] });
        }
      } catch (error) {
        console.error('Error drawing geofences:', error);
        showFallbackMap();
      }
    }

    function enableDrawingMode() {
      console.log('Enabling drawing mode...');
      
      // First ensure the map container is visible
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.style.display = 'block';

      // Check if Leaflet is available
      if (typeof L === 'undefined') {
        console.warn('Leaflet not available, using coordinate entry');
        alert('Map drawing is not available. Please use "Enter Coordinates" instead.');
        document.getElementById('geofenceModal').classList.add('active');
        document.getElementById('enterCoordinates').click();
        return;
      }

      // Initialize map if not already done
      if (!map) {
        console.log('Initializing map for drawing...');
        map = initializeMap();
      }

      // If map still not available after init, use coordinate entry
      if (!map) {
        console.warn('Map initialization failed, using coordinate entry');
        alert('Map drawing is not available. Please use "Enter Coordinates" instead.');
        document.getElementById('geofenceModal').classList.add('active');
        document.getElementById('enterCoordinates').click();
        return;
      }

      isDrawingMode = true;
      
      try {
        // Remove existing draw control if any
        if (drawControl) {
          map.removeControl(drawControl);
        }

        // Clear any existing drawn items
        if (drawnItems) {
          drawnItems.clearLayers();
        }

        // Add draw control
        drawControl = new L.Control.Draw({
          draw: {
            polygon: {
              allowIntersection: false,
              showArea: true,
              drawError: {
                color: '#e53e3e',
                message: 'Invalid polygon!'
              },
              shapeOptions: {
                color: document.getElementById('geofenceColor').value
              }
            },
            polyline: false,
            rectangle: true,
            circle: false,
            marker: false,
            circlemarker: false
          },
          edit: {
            featureGroup: drawnItems
          }
        });

        map.addControl(drawControl);

        // Handle polygon creation
        map.on(L.Draw.Event.CREATED, function (event) {
          console.log('Polygon created:', event);
          const layer = event.layer;
          drawnItems.addLayer(layer);
          
          // Get coordinates
          const coords = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
          tempGeofenceCoords = coords;
          
          // Remove draw control
          if (drawControl) {
            map.removeControl(drawControl);
            drawControl = null;
          }
          
          // Re-open modal to save
          document.getElementById('saveGeofence').disabled = false;
          document.getElementById('geofenceModal').classList.add('active');
          document.getElementById('coordinateInput').style.display = 'none';
          
          showMessage('infoBanner', '‚úÖ Polygon drawn! Now enter a name and click "Save Geofence".', 'success');
        });

        showMessage('infoBanner', 'üñäÔ∏è Drawing mode enabled. Draw a polygon or rectangle on the map.', 'info');
        
        // Fit map to a reasonable view
        map.fitBounds([[ -34, 172 ], [ -37, 175 ]]);
        
        console.log('Drawing mode enabled successfully');
        
      } catch (error) {
        console.error('Drawing mode error:', error);
        alert('Map drawing is not available. Please use "Enter Coordinates" instead.');
        document.getElementById('geofenceModal').classList.add('active');
        document.getElementById('enterCoordinates').click();
      }
    }

    function disableDrawingMode() {
      if (drawControl && map) {
        map.removeControl(drawControl);
        drawControl = null;
      }
      
      if (drawnItems) {
        drawnItems.clearLayers();
      }
      
      isDrawingMode = false;
      tempGeofenceCoords = null;
    }

    async function updateMapMarkers(locations) {
      if (!map || typeof L === 'undefined') {
        await updateFallbackMapWithVehicles(locations);
        return;
      }

      try {
        const activeGeofence = getActiveGeofence();
        if (!activeGeofence) return;

        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers.clear();

        const timeout = parseInt(document.getElementById('defaultTimeout').value) || 30;

        // Process each location asynchronously
        for (const location of locations) {
          const isInside = isInGeofence(location.latitude, location.longitude, activeGeofence);
          const vehicleNumber = await getVehicleNumberFromDevice(location.deviceId);
          const timePermitted = checkTimeRestrictions(vehicleNumber);

          let markerColor, statusText;

          if (!isInside && !timePermitted) {
            markerColor = '#e53e3e';
            statusText = 'Policy Violation ‚ö†Ô∏è';
          } else if (!isInside) {
            markerColor = '#ed8936';
            statusText = 'Outside Boundary';
          } else {
            markerColor = '#48bb78';
            statusText = 'Inside Boundary ‚úì';
          }

          const marker = L.circleMarker([location.latitude, location.longitude], {
            radius: 10,
            fillColor: markerColor,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);

          const popupContent = `
            <div style="min-width:200px;">
              <h4 style="margin:0 0 8px 0;">${location.deviceName} (Vehicle ${vehicleNumber})</h4>
              <p style="margin:4px 0;color:${markerColor};font-weight:600;">${statusText}</p>
              <p style="margin:4px 0;">üìç ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}</p>
              <p style="margin:4px 0;">üïê ${location.timestamp.toLocaleTimeString()}</p>
              <p style="margin:4px 0;">‚è±Ô∏è Timeout: ${timeout} min</p>
            </div>
          `;

          marker.bindPopup(popupContent);
          markers.set(location.deviceId, marker);
        }
      } catch (error) {
        console.error('Error updating markers:', error);
        await updateFallbackMapWithVehicles(locations);
      }
    }

    async function updateFallbackMapWithVehicles(locations) {
      const content = document.getElementById('fallbackMapContent');
      if (!content) {
        console.warn('Fallback map content element not found');
        return;
      }

      console.log('Updating fallback map with vehicles:', locations.length, 'locations');
      const activeGeofence = getActiveGeofence();
      console.log('Active geofence:', activeGeofence?.name);

      let html = '<div style="text-align:left;width:100%;">';

      // Show active geofence
      if (activeGeofence) {
        const center = calculateCenter(activeGeofence.coordinates);
        const mapLink = `https://www.google.com/maps?q=${center[0]},${center[1]}&z=10`;

        html += '<div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">';
        html += '<h4 style="margin-bottom:15px;color:#1e3c72;">üìç Active Policy Boundary:</h4>';
        html += `
          <div style="background:#c6f6d5;padding:15px;border-radius:8px;border-left:4px solid ${activeGeofence.color};">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
              <div>
                <strong style="font-size:16px;">${activeGeofence.name}</strong><br>
                <span style="color:#718096;font-size:14px;">${activeGeofence.coordinates.length} boundary points</span>
              </div>
              <a href="${mapLink}" target="_blank" class="btn btn-info btn-sm" style="text-decoration:none;white-space:nowrap;">üó∫Ô∏è View Zone</a>
            </div>
          </div>
        `;
        html += '</div>';
      }

      // Show vehicles
      if (locations && locations.length > 0) {
        html += '<div style="background:white;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">';
        html += '<h4 style="margin-bottom:15px;color:#1e3c72;">üöó Vehicle Policy Compliance:</h4>';

        // Process each location asynchronously
        for (const location of locations) {
          const isInside = activeGeofence ? isInGeofence(location.latitude, location.longitude, activeGeofence) : false;
          const vehicleNumber = await getVehicleNumberFromDevice(location.deviceId);
          const timePermitted = checkTimeRestrictions(vehicleNumber);

          let statusColor, statusText;

          if (!isInside && !timePermitted) {
            statusColor = '#e53e3e';
            statusText = 'üö® Policy Violation';
          } else if (!isInside) {
            statusColor = '#ed8936';
            statusText = '‚ö†Ô∏è Outside Boundary';
          } else {
            statusColor = '#48bb78';
            statusText = '‚úì Compliant';
          }

          const mapLink = `https://www.google.com/maps?q=${location.latitude},${location.longitude}&z=15`;

          html += `
            <div style="background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid ${statusColor};">
              <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px;">
                <div style="flex:1;">
                  <strong style="font-size:16px;">${location.deviceName} (Vehicle ${vehicleNumber})</strong><br>
                  <span style="color:${statusColor};font-weight:600;font-size:14px;">${statusText}</span><br>
                  <span style="color:#718096;font-size:13px;">üìç ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}</span><br>
                  <span style="color:#718096;font-size:13px;">üïê ${location.timestamp.toLocaleString()}</span>
                </div>
                <a href="${mapLink}" target="_blank" class="btn btn-info btn-sm" style="text-decoration:none;white-space:nowrap;align-self:center;">üó∫Ô∏è View Location</a>
              </div>
            </div>
          `;
        }
        html += '</div>';
      } else if (activeGeofence) {
        html += '<div style="background:white;padding:20px;border-radius:10px;text-align:center;">';
        html += '<p style="color:#718096;">No vehicle locations available. Click "Check Policy Compliance" to refresh.</p>';
        html += '</div>';
      }

      html += '</div>';
      content.innerHTML = html;
    }

    // POLICY VIOLATION ALERTS
    function triggerBoundaryViolationAlert(location, vehicleNumber) {
      const driver = location.deviceName;
      const alertMsg = `
        üö® BOUNDARY VIOLATION
        Vehicle: ${vehicleNumber} - ${driver}
        Location: ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}
        Time: ${new Date().toLocaleString()}
        Status: Outside permitted area
        Action: Requires Senior Leadership approval
      `;
      console.log('BOUNDARY VIOLATION:', alertMsg);
      
      if (document.getElementById('enableAlerts').checked) {
        playAlertSound();
      }
    }

    function triggerTimeViolationAlert(location, vehicleNumber) {
      const driver = location.deviceName;
      const alertMsg = `
        üö® AFTER-HOURS USAGE
        Vehicle: ${vehicleNumber} - ${driver}  
        Location: ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}
        Time: ${new Date().toLocaleString()}
        Status: Vehicle used during restricted hours
        Permitted: After 6pm & before 4am Weekdays + All Weekend
      `;
      console.log('TIME VIOLATION:', alertMsg);
      
      if (document.getElementById('enableAlerts').checked) {
        playAlertSound();
      }
    }

    async function checkBoundaryViolations() {
      try {
        const activeGeofence = getActiveGeofence();
        if (!activeGeofence) {
          showMessage('infoBanner', 'Please select a geofence to monitor', 'warning');
          return;
        }

        const locations = await getCurrentLocations();
        const timeout = parseInt(document.getElementById('defaultTimeout').value) || 30;
        const now = new Date();

        let totalMonitored = 0;
        let insideCount = 0;
        let outsideCount = 0;
        let violationCount = 0;

        const tableRows = [];

        // Process each location and map devices to vehicles
        for (const location of locations) {
          totalMonitored++;
          const isInside = isInGeofence(location.latitude, location.longitude, activeGeofence);
          const vehicleNumber = await getVehicleNumberFromDevice(location.deviceId);
          const timePermitted = checkTimeRestrictions(vehicleNumber);

          if (isInside) {
            insideCount++;
            // Remove from violations if back inside
            if (activeViolations.has(location.deviceId)) {
              activeViolations.delete(location.deviceId);
            }
          } else {
            outsideCount++;

            const violationKey = location.deviceId;

            if (!activeViolations.has(violationKey)) {
              activeViolations.set(violationKey, {
                deviceId: location.deviceId,
                deviceName: location.deviceName,
                vehicleNumber: vehicleNumber,
                startTime: now,
                location: location,
                violationType: timePermitted ? 'boundary' : 'time-boundary'
              });

              // Trigger appropriate alert
              if (timePermitted) {
                triggerBoundaryViolationAlert(location, vehicleNumber);
              } else {
                triggerTimeViolationAlert(location, vehicleNumber);
              }
            }

            violationCount++;
          }

          let statusClass, statusText;
          if (!isInside && !timePermitted) {
            statusClass = 'status-outside';
            statusText = 'Policy Violation üö®';
          } else if (!isInside) {
            statusClass = 'status-outside';
            statusText = 'Outside Boundary';
          } else {
            statusClass = 'status-inside';
            statusText = 'Inside Boundary ‚úì';
          }

          tableRows.push(`
            <tr>
              <td><strong>${location.deviceName}</strong> (Vehicle ${vehicleNumber})</td>
              <td>${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}</td>
              <td><span class="${statusClass}">${statusText}</span></td>
              <td>${location.timestamp.toLocaleString()}</td>
            </tr>
          `);
        }

        // Update statistics
        document.getElementById('totalMonitored').textContent = totalMonitored;
        document.getElementById('insideBoundary').textContent = insideCount;
        document.getElementById('outsideBoundary').textContent = outsideCount;
        document.getElementById('violations').textContent = violationCount;
        document.getElementById('monitoringStats').style.display = 'block';

        // Update table
        const resultHTML = `
          <h4>Policy Compliance - ${now.toLocaleTimeString()} (Monitoring: ${activeGeofence.name})</h4>
          <table class="geofence-table">
            <thead>
              <tr>
                <th>Vehicle</th>
                <th>Location</th>
                <th>Compliance Status</th>
                <th>Last Update</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows.length > 0 ? tableRows.join('') : '<tr><td colspan="4" style="text-align:center;">No data available</td></tr>'}
            </tbody>
          </table>
        `;

        document.getElementById('monitoringResult').innerHTML = resultHTML;

        // Update map if visible
        if (map) {
          await updateMapMarkers(locations);
        }

        // Update alert panel
        updateAlertPanel();

      } catch (error) {
        console.error('Error checking violations:', error);
        showMessage('infoBanner', `Error: ${error.message}`, 'error');
      }
    }

    function updateAlertPanel() {
      if (activeViolations.size === 0) {
        document.getElementById('alertPanel').style.display = 'none';
        return;
      }

      document.getElementById('alertPanel').style.display = 'block';
      
      let alertsHTML = '';
      activeViolations.forEach(violation => {
        const duration = Math.floor((new Date() - violation.startTime) / 1000 / 60);
        const violationType = violation.violationType === 'time-boundary' ? 'Time & Boundary Violation' : 'Boundary Violation';
        
        alertsHTML += `
          <div class="violation-item">
            <strong>${violation.deviceName}</strong><br>
            <span style="color:#e53e3e;font-weight:600;">${violationType}</span><br>
            <span class="muted">Duration: ${duration} min</span><br>
            <span class="muted">${violation.location.latitude.toFixed(4)}, ${violation.location.longitude.toFixed(4)}</span>
          </div>
        `;
      });
      
      document.getElementById('activeAlerts').innerHTML = alertsHTML;
    }

    function playAlertSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.warn('Audio alerts not supported:', e);
      }
    }

    // Geofence Management Functions
    window.viewGeofence = function(geofenceId) {
      const geofence = geofences.find(g => g.id === geofenceId);
      if (!geofence) return;

      if (!map || typeof L === 'undefined') {
        // Fallback: show geofence details and map link
        const center = calculateCenter(geofence.coordinates);
        const mapLink = `https://www.google.com/maps?q=${center[0]},${center[1]}&z=10`;
        
        showMessage('infoBanner', `
          <strong>${geofence.name}</strong><br>
          Boundary points: ${geofence.coordinates.length}<br>
          <a href="${mapLink}" target="_blank" style="color:#1e3c72;">View on Google Maps ‚Üí</a>
        `, 'info');
        return;
      }

      const polygon = geofencePolygons.get(geofenceId);
      if (polygon) {
        map.fitBounds(polygon.getBounds(), { padding: [50, 50] });
        polygon.openPopup();
      }

      showMessage('infoBanner', `Viewing: ${geofence.name}`, 'info');
    };

    window.exportGeofence = function(geofenceId) {
      const geofence = geofences.find(g => g.id === geofenceId);
      if (!geofence) return;

      const exportData = {
        name: geofence.name,
        coordinates: geofence.coordinates,
        color: geofence.color
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${geofence.name.replace(/\s+/g, '_')}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      
      showMessage('infoBanner', `‚úÖ Exported: ${geofence.name}`, 'success');
    };

    window.deleteGeofence = function(geofenceId) {
      if (!confirm('Are you sure you want to delete this geofence?')) return;

      geofences = geofences.filter(g => g.id !== geofenceId);
      
      const polygon = geofencePolygons.get(geofenceId);
      if (polygon && map) {
        map.removeLayer(polygon);
      }
      geofencePolygons.delete(geofenceId);

      renderGeofenceList();
      updateActiveGeofenceSelect();
      
      showMessage('infoBanner', '‚úÖ Geofence deleted', 'success');
    };

    // Modal Controls
    document.getElementById('createGeofence').onclick = function() {
      document.getElementById('modalTitle').textContent = 'Create New Geofence';
      document.getElementById('geofenceName').value = '';
      document.getElementById('geofenceColor').value = '#1e3c72';
      document.getElementById('coordinateInput').style.display = 'none';
      document.getElementById('saveGeofence').disabled = true;
      tempGeofenceCoords = null;
      
      document.getElementById('geofenceModal').classList.add('active');
    };

    document.getElementById('drawOnMap').onclick = function() {
      const name = document.getElementById('geofenceName').value.trim();
      if (!name) {
        alert('Please enter a geofence name first');
        return;
      }
      
      document.getElementById('geofenceModal').classList.remove('active');
      
      // Small delay to ensure modal is closed before map interaction
      setTimeout(() => {
        enableDrawingMode();
      }, 100);
    };

    document.getElementById('enterCoordinates').onclick = function() {
      const name = document.getElementById('geofenceName').value.trim();
      if (!name) {
        alert('Please enter a geofence name first');
        return;
      }
      
      document.getElementById('coordinateInput').style.display = 'block';
      document.getElementById('saveGeofence').disabled = false;
    };

    document.getElementById('cancelGeofence').onclick = function() {
      document.getElementById('geofenceModal').classList.remove('active');
      disableDrawingMode();
      
      // Reset coordinate input
      document.getElementById('coordinateInput').style.display = 'none';
      document.getElementById('coordTextarea').value = '';
      tempGeofenceCoords = null;
    };

    document.getElementById('saveGeofence').onclick = function() {
      const name = document.getElementById('geofenceName').value.trim();
      const color = document.getElementById('geofenceColor').value;
      
      if (!name) {
        alert('Please enter a geofence name');
        return;
      }

      let coordinates = tempGeofenceCoords;
      
      // If coordinates were entered manually
      if (!coordinates) {
        const coordText = document.getElementById('coordTextarea').value.trim();
        if (!coordText) {
          alert('Please draw on map or enter coordinates');
          return;
        }
        
        try {
          coordinates = coordText.split('\n').map(line => {
            const [lat, lng] = line.split(',').map(s => parseFloat(s.trim()));
            if (isNaN(lat) || isNaN(lng)) throw new Error('Invalid coordinates');
            return [lat, lng];
          });
        } catch (e) {
          alert('Invalid coordinate format. Use: lat, lng (one per line)');
          return;
        }
      }

      const newGeofence = {
        id: 'geo-' + Date.now(),
        name: name,
        coordinates: coordinates,
        color: color,
        active: false
      };

      geofences.push(newGeofence);
      
      document.getElementById('geofenceModal').classList.remove('active');
      disableDrawingMode();
      
      renderGeofenceList();
      updateActiveGeofenceSelect();
      
      if (map) {
        drawAllGeofences();
      }
      
      showMessage('infoBanner', `‚úÖ Geofence "${name}" created successfully!`, 'success');
    };

    document.getElementById('importGeofence').onclick = function() {
      document.getElementById('importTextarea').value = '';
      document.getElementById('importModal').classList.add('active');
    };

    document.getElementById('cancelImport').onclick = function() {
      document.getElementById('importModal').classList.remove('active');
    };

    document.getElementById('confirmImport').onclick = function() {
      const importText = document.getElementById('importTextarea').value.trim();
      if (!importText) {
        alert('Please paste geofence JSON');
        return;
      }

      try {
        const importData = JSON.parse(importText);
        
        if (!importData.name || !importData.coordinates) {
          throw new Error('Invalid geofence format');
        }

        const newGeofence = {
          id: 'geo-' + Date.now(),
          name: importData.name,
          coordinates: importData.coordinates,
          color: importData.color || '#1e3c72',
          active: false
        };

        geofences.push(newGeofence);
        
        document.getElementById('importModal').classList.remove('active');
        
        renderGeofenceList();
        updateActiveGeofenceSelect();
        
        if (map) {
          drawAllGeofences();
        }
        
        showMessage('infoBanner', `‚úÖ Imported: ${newGeofence.name}`, 'success');
        
      } catch (e) {
        alert('Invalid JSON format: ' + e.message);
      }
    };

    // Load Policy Geofences
    document.getElementById('loadPolicyGeofences').onclick = loadPolicyGeofences;

    // Main Controls
    document.getElementById('authButton').onclick = async function(){
      const server = document.getElementById('server').value.trim();
      const database = document.getElementById('database').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if(!server || !database || !username || !password){ 
        showMessage('authResult','Please fill in all fields','error'); 
        return; 
      }
      
      try{
        showMessage('authResult','Authenticating...','warning');
        serverUsed = server;
        const res = await callGeotabAPI('Authenticate', { userName:username, password, database });
        
        if(res.path && res.path !== 'ThisServer'){
          serverUsed = res.path;
          const res2 = await callGeotabAPI('Authenticate', { userName:username, password, database });
          credentials = res2.credentials;
        } else {
          credentials = res.credentials;
        }
        
        showMessage('authResult','‚úÖ Authentication successful!','success');
        document.getElementById('monitoringSection').style.display = '';
        
        initializeGeofences();
        
      }catch(e){
        showMessage('authResult',`‚ùå Authentication failed: ${e.message}`,'error');
      }
    };

    document.getElementById('startMonitoring').onclick = async function(){
      if (isMonitoring) return;
      
      const activeGeofence = getActiveGeofence();
      if (!activeGeofence) {
        showMessage('infoBanner', 'Please select a geofence to monitor', 'error');
        return;
      }
      
      try {
        isMonitoring = true;
        document.getElementById('startMonitoring').disabled = true;
        document.getElementById('stopMonitoring').disabled = false;
        
        showMessage('infoBanner', `üöÄ Policy monitoring started for: ${activeGeofence.name}`, 'success');
        
        await checkBoundaryViolations();
        
        const interval = parseInt(document.getElementById('checkInterval').value) || 30;
        monitoringInterval = setInterval(checkBoundaryViolations, interval * 1000);
        
      } catch (error) {
        isMonitoring = false;
        document.getElementById('startMonitoring').disabled = false;
        document.getElementById('stopMonitoring').disabled = true;
        showMessage('infoBanner', `Error: ${error.message}`, 'error');
      }
    };

    document.getElementById('stopMonitoring').onclick = function(){
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
      }
      
      isMonitoring = false;
      document.getElementById('startMonitoring').disabled = false;
      document.getElementById('stopMonitoring').disabled = true;
      
      showMessage('infoBanner', '‚èπÔ∏è Policy monitoring stopped', 'warning');
    };

    document.getElementById('checkViolations').onclick = checkBoundaryViolations;

    document.getElementById('showMap').onclick = async function(){
      try {
        showMessage('infoBanner', 'üó∫Ô∏è Loading policy map...', 'info');

        initializeMap();

        // Always try to load locations when showing map
        const locations = await getCurrentLocations();

        if (map && typeof L !== 'undefined') {
          await updateMapMarkers(locations);
          showMessage('infoBanner', `‚úÖ Interactive map showing ${locations.length} vehicles and ${geofences.length} policy geofences`, 'success');
        } else {
          // In fallback mode, show geofences and vehicles
          await updateFallbackMapWithVehicles(locations);
          showMessage('infoBanner', `‚úÖ Showing ${geofences.length} policy geofences and ${locations.length} vehicles`, 'info');
        }

      } catch (error) {
        console.error('Show map error:', error);
        showMessage('infoBanner', `Error loading locations: ${error.message}`, 'error');

        // Still show the map container with geofences even if vehicle loading fails
        if (!map || typeof L === 'undefined') {
          showFallbackMap();
        }
      }
    };

    document.getElementById('acknowledgeAll').onclick = function(){
      activeViolations.clear();
      updateAlertPanel();
      showMessage('infoBanner', '‚úÖ All policy violations acknowledged', 'success');
    };

    document.getElementById('closeAlerts').onclick = function(){
      document.getElementById('alertPanel').style.display = 'none';
    };

    document.getElementById('logout').onclick = function(){
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
      }
      
      if (map) {
        map.remove();
        map = null;
      }
      
      credentials = null;
      serverUsed = null;
      isMonitoring = false;
      activeViolations.clear();
      geofences = [];
      geofencePolygons.clear();
      
      document.getElementById('monitoringSection').style.display = 'none';
      document.getElementById('authResult').innerHTML = '';
      document.getElementById('monitoringResult').innerHTML = '';
      document.getElementById('monitoringStats').style.display = 'none';
      document.getElementById('alertPanel').style.display = 'none';
      document.getElementById('mapContainer').style.display = 'none';
      
      showMessage('authResult','‚úÖ Logged out successfully','success');
    };

    // Close modals on outside click
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
        disableDrawingMode();
      }
    };

    // Enhanced environment detection on load
    document.addEventListener('DOMContentLoaded', function() {
      const env = detectEnvironment();
      console.log('Environment detected:', env);
      
      if (env.leafletAvailable) {
        console.log('‚úÖ Leaflet is available - maps should work');
      } else {
        console.warn('‚ö†Ô∏è Leaflet not available - using fallback mode');
      }
      
      // Auto-load policy geofences if in Geotab environment
      if (env.isGeotab) {
        console.log('üîÑ Auto-loading policy geofences for Geotab environment');
        // We'll load these after authentication
      }
    });
  </script>
</body>
</html>
